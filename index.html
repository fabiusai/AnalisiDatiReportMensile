<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Social Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #00529F;
      --primary-hover: #003e7e;
      --secondary: #FFD700;
      --bg: #f4f6f8;
      --text: #2c3e50;
      --text-light: #607d8b;
      --card-bg: #fff;
      --border-radius: 8px;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --border: 1px solid #e1e4e8;
      --icon-size: 1.5rem; 
      --icon-color: #00529F; /* Colore Blu per le icone */
    }
    
    body { 
      margin: 0; 
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      font-size: 16px; 
      line-height: 1.6; 
    }
    
    /* Header */
    header { 
      background: var(--primary); 
      color: #fff; 
      padding: 1rem 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
    }
    header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    
    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
    
    /* Area Upload */
    .upload-area {
      background: var(--card-bg);
      border: 3px dashed #cbd5e0;
      border-radius: var(--border-radius);
      padding: 2.5rem;
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
      transition: all 0.2s;
      cursor: pointer;
    }
    .upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
    .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .upload-text { font-size: 1.2rem; color: var(--text-light); font-weight: 500; }
    .upload-icon { font-size: 3rem; color: var(--primary); margin-bottom: 1rem; display: block; }

    /* Tabs */
    .tabs-container { display: none; }
    
    .tabs-header {
      display: flex;
      gap: 10px;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 1px;
    }
    
    .tab-btn {
      padding: 12px 25px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      font-size: 1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .tab-content { display: none; animation: fadeIn 0.4s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Pulsante Executive */
    #exec-btn { 
      background-color: #27ae60; color: white; border: none; padding: 10px 20px; 
      border-radius: 6px; font-weight: 600; cursor: pointer; display: none; font-size: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.1s;
    }
    #exec-btn:hover { background-color: #219150; transform: translateY(-1px); }
    #exec-btn i { margin-right: 8px; }

    /* Cards */
    .card { background: var(--card-bg); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: var(--border); }
    .card h2 { margin-top: 0; color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.8rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.5rem; }
    .stat-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: var(--border-radius);
      padding: 1.2rem; position: relative; border-left: 5px solid #ddd;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left-color: var(--primary); }
    
    .stat-label { 
        font-size: 0.95rem; 
        color: var(--text-light); 
        text-transform: uppercase; 
        font-weight: 600; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        margin-bottom: 0.8rem; 
    }

    /* Icone BLU e Grandi */
    .stat-label i {
        font-size: var(--icon-size);
        color: var(--icon-color);
        transition: transform 0.3s;
    }
    .stat-card:hover .stat-label i { transform: scale(1.1); }

    .stat-value { 
        font-size: 1.8rem; 
        font-weight: 700; 
        color: var(--text); 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        min-height: 40px; 
    }

    /* Tabelle */
    .table-wrapper { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    table { width: 100%; border-collapse: collapse; font-size: 1rem; min-width: 800px; }
    th { background: #f8fafc; color: #4a5568; font-weight: 700; padding: 1rem; text-align: left; border-bottom: 2px solid #e2e8f0; }
    td { padding: 1rem; border-bottom: 1px solid #edf2f7; vertical-align: middle; position: relative; }
    tr:hover td { background-color: #f7fafc; }

    /* --- TASTO COPIA (Ghost) --- */
    .copy-btn {
      background: transparent; 
      color: #999; 
      border: none; 
      padding: 6px 10px; 
      font-size: 1rem; 
      cursor: pointer; 
      border-radius: 4px; 
      margin-left: 10px;
      transition: all 0.2s ease-in-out;
      opacity: 0; /* Invisibile */
      pointer-events: none; /* Non cliccabile se invisibile */
    }

    /* Logica di visibilità */
    tr:hover .copy-btn,
    .stat-value:hover .copy-btn {
        opacity: 1;
        pointer-events: auto; /* Cliccabile quando visibile */
    }

    .copy-btn:hover { 
        background: #eee; 
        color: var(--primary);
        transform: scale(1.1);
        opacity: 1 !important;
    }
    
    /* Link Button */
    a.link-btn { 
      color: var(--primary); background: #ebf8ff; padding: 6px 12px; border-radius: 4px; 
      text-decoration: none; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px;
    }
    a.link-btn:hover { background: var(--primary); color: white; }

    .save-table, .save-channel-table { 
        background: #f1c40f; color: #333; border: none; padding: 8px 16px; font-size: 0.95rem; 
        cursor: pointer; border-radius: 4px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
    }
    .save-table:hover, .save-channel-table:hover { background: #d4ac0d; }

    /* Toast */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 24px; color: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

  </style>
</head>
<body>

  <header>
    <h1><i class="fas fa-chart-line"></i> Dashboard Report Social</h1>
    <button id="exec-btn"><i class="fas fa-file-code"></i> Scarica JSON Executive</button>
  </header>
  
  <div id="toast-container"></div>

  <div class="container">
    
    <div class="upload-area" id="upload-box">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <span class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></span>
      <div class="upload-text" id="upload-label">
        Trascina il file Excel qui o clicca per caricare
      </div>
    </div>

    <div id="main-content" class="tabs-container">
      
      <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('tab-overview')"><i class="fas fa-home"></i> Panoramica</button>
        <button class="tab-btn" onclick="switchTab('tab-instit')"><i class="fas fa-building"></i> Istituzionale</button>
        <button class="tab-btn" onclick="switchTab('tab-topics')"><i class="fas fa-tags"></i> Argomenti</button>
        <button class="tab-btn" onclick="switchTab('tab-channels')"><i class="fas fa-share-alt"></i> Canali</button>
      </div>

      <div id="tab-overview" class="tab-content active"></div>
      <div id="tab-instit" class="tab-content"></div>
      <div id="tab-topics" class="tab-content"></div>
      <div id="tab-channels" class="tab-content"></div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const fileInput = document.getElementById('file-input');
    const uploadLabel = document.getElementById('upload-label');
    const execBtn = document.getElementById('exec-btn');
    const mainContent = document.getElementById('main-content');
    let workbookData = null;
    let latestExecutiveData = null;

    function showToast(msg, type) {
        const c = document.getElementById('toast-container');
        const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `${icon} ${msg}`;
        c.appendChild(t); setTimeout(() => t.remove(), 4000);
    }

    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const map = {'tab-overview':0, 'tab-instit':1, 'tab-topics':2, 'tab-channels':3};
        document.querySelectorAll('.tab-btn')[map[tabId]].classList.add('active');
    }

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      uploadLabel.innerHTML = `⏳ Elaborazione di <strong>${file.name}</strong>...`;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
            workbookData = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(workbookData.Sheets[workbookData.SheetNames[0]], { raw: false });
            renderReport(data);
            mainContent.style.display = 'block';
            execBtn.style.display = 'inline-block';
            uploadLabel.innerHTML = `✅ <strong>${file.name}</strong> caricato con successo.`;
            showToast('Dati elaborati correttamente', 'success');
        } catch (err) {
            console.error(err);
            uploadLabel.innerHTML = `❌ Errore nel file.`;
            showToast('Errore lettura file Excel', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    execBtn.addEventListener('click', () => {
        if (!latestExecutiveData) return;
        const now = new Date();
        const filename = `ES2_${now.toISOString().slice(0,19).replace(/[-:T]/g,'_')}.json`;
        const blob = new Blob([JSON.stringify(latestExecutiveData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });

    // Helpers
    function formatDate(t) { if(!t) return ''; let d,m,y; if(/^\d{4}-\d{2}-\d{2}$/.test(t))[y,m,d]=t.split('-'); else if(/^\d{2}\/\d{2}\/\d{4}$/.test(t))[d,m,y]=t.split('/'); else{const dt=new Date(t);if(!isNaN(dt)){d=dt.getDate();m=dt.getMonth()+1;y=dt.getFullYear();}else return t;} return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y.toString().slice(-2)}`; }
    function formatNumber(n) { n=Number(n)||0; if(n<1000)return n.toString(); if(n<1000000)return `${Math.round(n/1000)}K`; return `${(n/1000000).toFixed(2).replace('.',',')}M`; }
    function formatNumberForJson(n) { let v=Number(n)||0; if(v>=1000000)return (v/1000000).toFixed(2).replace('.',',')+"M"; if(v>=1000)return Math.round(v/1000)+"K"; return v.toString().replace('.',','); }

    // --- FUNZIONE COPIA ROBUSTA (FALLBACK) ---
    function executeCopy(text, btnElement) {
        const successFeedback = () => {
            btnElement.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btnElement.innerHTML = '<i class="far fa-copy"></i>', 1500);
        };
        const failFeedback = () => {
            alert('Copia fallita. Controlla i permessi del browser.');
        };

        // Metodo 1: Clipboard API (Moderno)
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(successFeedback).catch(() => {
                // Se fallisce, prova metodo 2
                fallbackCopy(text, btnElement, successFeedback, failFeedback);
            });
        } else {
            // Metodo 2: Fallback (Locale / HTTP)
            fallbackCopy(text, btnElement, successFeedback, failFeedback);
        }
    }

    function fallbackCopy(text, btnElement, onSuccess, onFail) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        textArea.style.left = "-9999px"; 
        textArea.style.top = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            if (successful) onSuccess();
            else onFail();
        } catch (err) {
            document.body.removeChild(textArea);
            onFail();
        }
    }

    function createCopyBtn(textToCopy) {
        const b = document.createElement('button'); 
        b.className = 'copy-btn'; 
        b.innerHTML = '<i class="far fa-copy"></i>'; 
        b.title = "Copia valore";
        const safeText = String(textToCopy !== undefined && textToCopy !== null ? textToCopy : "");

        b.onclick = (e) => { 
            e.stopPropagation(); 
            executeCopy(safeText, b);
        };
        return b;
    }
    
    function getChannelIcon(name) {
        const n = name.toLowerCase();
        if(n.includes('facebook')) return '<i class="fab fa-facebook"></i>';
        if(n.includes('instagram')) return '<i class="fab fa-instagram"></i>';
        if(n.includes('linkedin')) return '<i class="fab fa-linkedin"></i>';
        if(n.includes('twitter') || n.includes('x')) return '<i class="fa-brands fa-x-twitter"></i>'; 
        if(n.includes('youtube')) return '<i class="fab fa-youtube"></i>';
        if(n.includes('whatsapp')) return '<i class="fab fa-whatsapp"></i>';
        return '<i class="fas fa-share-alt"></i>';
    }

    // MAIN RENDER
    function renderReport(data) {
      const filtered = data.filter(r=>String(r.Campagna).trim().toLowerCase()==='editoriale');
      const tabs = { ov: document.getElementById('tab-overview'), inst: document.getElementById('tab-instit'), top: document.getElementById('tab-topics'), chan: document.getElementById('tab-channels') };
      Object.values(tabs).forEach(t => t.innerHTML = '');

      // 1. OVERVIEW
      const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
      filtered.forEach(r => {
          const c = r.Canale.trim().toLowerCase();
          if(c.includes('facebook')) counts.fb++; else if(c.includes('instagram')) counts.ig++; else if(c==='whatsapp') counts.wa++; else if(c.includes('twitter') || c.includes('x')) counts.tw++; else if(c.includes('linkedin')) counts.li++; else if(c.includes('youtube')) counts.yt++;
      });
      const totals = { 
          'Post Totali': {val: filtered.length, icon: '<i class="fas fa-layer-group"></i>'}, 
          'Facebook': {val: counts.fb, icon: getChannelIcon('facebook')}, 
          'Instagram': {val: counts.ig, icon: getChannelIcon('instagram')}, 
          'LinkedIn': {val: counts.li, icon: getChannelIcon('linkedin')}, 
          'X (Twitter)': {val: counts.tw, icon: getChannelIcon('x')}, 
          'YouTube': {val: counts.yt, icon: getChannelIcon('youtube')}, 
          'WhatsApp': {val: counts.wa, icon: getChannelIcon('whatsapp')} 
      };

      const ovCard = document.createElement('div'); ovCard.className = 'card';
      ovCard.innerHTML = '<h2><i class="fas fa-chart-pie"></i> Volumi di Pubblicazione</h2>';
      const grid = document.createElement('div'); grid.className = 'stats-grid';
      Object.entries(totals).forEach(([k, obj]) => {
          const card = document.createElement('div'); card.className = 'stat-card';
          const valDiv = document.createElement('div'); valDiv.className = 'stat-value';
          valDiv.textContent = obj.val; valDiv.appendChild(createCopyBtn(obj.val));
          card.innerHTML = `<span class="stat-label">${obj.icon} ${k}</span>`;
          card.appendChild(valDiv); grid.appendChild(card);
      });
      ovCard.appendChild(grid); tabs.ov.appendChild(ovCard);

      // 2. ISTITUZIONALI
      const istit = filtered.filter(r=>String(r.Istituzionale).trim()==='1');
      const kpiIst = {
          'N. Post': istit.length,
          'Visualizzazioni': istit.reduce((s,r)=>s+(Number(r.Visualizzazioni)||0),0),
          'Interazioni': istit.reduce((s,r)=>s+(Number(r.Interazioni)||0),0),
          'Like/Reazioni': istit.reduce((s,r)=>s+(Number(r['Like e reazioni'])||0),0),
          'Condivisioni': istit.reduce((s,r)=>s+(Number(r.Condivisioni)||0),0)
      };

      const istCard = document.createElement('div'); istCard.className='card';
      istCard.innerHTML = '<h2><i class="fas fa-university"></i> KPI Istituzionali</h2>';
      const istGrid = document.createElement('div'); istGrid.className = 'stats-grid';
      Object.entries(kpiIst).forEach(([k,v]) => {
          const card = document.createElement('div'); card.className = 'stat-card';
          const valDiv = document.createElement('div'); valDiv.className = 'stat-value';
          const fmt = formatNumber(v); valDiv.textContent = fmt; valDiv.appendChild(createCopyBtn(fmt));
          card.innerHTML = `<span class="stat-label">${k}</span>`;
          card.appendChild(valDiv); istGrid.appendChild(card);
      });
      istCard.appendChild(istGrid);

      // Best Perf Table
      const agg={};istit.forEach(r=>{const a=r.Argomento||'ND';if(!agg[a])agg[a]={v:0,i:0,l:0,c:0,lnk:r.Link};agg[a].v+=Number(r.Visualizzazioni)||0;agg[a].i+=Number(r.Interazioni)||0;agg[a].l+=Number(r['Like e reazioni'])||0;agg[a].c+=Number(r.Condivisioni)||0;});
      const top5=Object.entries(agg).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,5);

      const perfDiv = document.createElement('div'); perfDiv.style.marginTop='2rem';
      perfDiv.innerHTML = '<h3><i class="fas fa-trophy"></i> Best Performers (Top 5 per visualizzazioni)</h3>';
      const tblWrap = document.createElement('div'); tblWrap.className='table-wrapper';
      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th>Argomento</th><th>Visualizzazioni</th><th>Interazioni</th><th>Like</th><th>Link</th></tr></thead><tbody></tbody>';
      top5.forEach(o => {
          const tr = document.createElement('tr');
          [[o.arg],[formatNumber(o.v)],[formatNumber(o.i)],[formatNumber(o.l)]].forEach(([val]) => {
              const td = document.createElement('td'); td.textContent = val; td.appendChild(createCopyBtn(val)); tr.appendChild(td);
          });
          tr.innerHTML += `<td><a href="${o.lnk}" target="_blank" class="link-btn"><i class="fas fa-external-link-alt"></i> Apri</a></td>`;
          tbl.querySelector('tbody').appendChild(tr);
      });
      tblWrap.appendChild(tbl); perfDiv.appendChild(tblWrap);
      
      const btnSaveI = document.createElement('button'); btnSaveI.className='save-table'; btnSaveI.innerHTML='<i class="fas fa-file-excel"></i> Salva Excel Istituzionale';
      btnSaveI.onclick = () => {
          const wb=XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.entries(kpiIst).map(([k,v])=>({KPI:k, Valore:v}))), 'KPI');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(top5), 'Best_Perf');
          XLSX.writeFile(wb, 'Report_Istituzionale.xlsx');
      };
      
      istCard.appendChild(perfDiv); istCard.appendChild(btnSaveI); tabs.inst.appendChild(istCard);

      // 3. ARGOMENTI
      const topics={}; filtered.forEach(r=>{const a=r.Argomento||'Altro'; const v=Number(r.Visualizzazioni)||0; if(!topics[a])topics[a]={n:0,v:0}; topics[a].n++; topics[a].v+=v;});
      const topTopics = Object.entries(topics).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,10);

      const topicCard = document.createElement('div'); topicCard.className='card';
      topicCard.innerHTML = '<h2><i class="fas fa-list-ol"></i> Top 10 Argomenti</h2>';
      const tblTWrap = document.createElement('div'); tblTWrap.className='table-wrapper';
      const tblT = document.createElement('table');
      tblT.innerHTML = '<thead><tr><th>Argomento</th><th>N. Post</th><th>Visualizzazioni Totali</th></tr></thead><tbody></tbody>';
      topTopics.forEach(t => {
          const tr = document.createElement('tr');
          const fmtV = formatNumber(t.v);
          [[t.arg], [t.n], [fmtV]].forEach(([val]) => {
             const td = document.createElement('td'); td.textContent = val; td.appendChild(createCopyBtn(val)); tr.appendChild(td);
          });
          tblT.querySelector('tbody').appendChild(tr);
      });
      tblTWrap.appendChild(tblT); topicCard.appendChild(tblTWrap); tabs.top.appendChild(topicCard);

      // EXECUTIVE
      const safeTop = [...topTopics]; while(safeTop.length<3) safeTop.push({arg:"",v:0});
      latestExecutiveData = {
          "Numero post Facebook": formatNumberForJson(counts.fb),
          "Numero post X (Twitter)": formatNumberForJson(counts.tw),
          "Numero post Linkedin": formatNumberForJson(counts.li),
          "Numero post Instagram": formatNumberForJson(counts.ig),
          "Numero post Youtube": formatNumberForJson(counts.yt),
          "Numero post Whatsapp": formatNumberForJson(counts.wa),
          "Argomenti più visualizzati 1": safeTop[0].arg, "Visualizzazione Argomenti più visualizzati 1": formatNumberForJson(safeTop[0].v),
          "Argomenti più visualizzati 2": safeTop[1].arg, "Visualizzazione Argomenti più visualizzati 2": formatNumberForJson(safeTop[1].v),
          "Argomenti più visualizzati 3": safeTop[2].arg, "Visualizzazione Argomenti più visualizzati 3": formatNumberForJson(safeTop[2].v),
          "Numero post istituzionali": formatNumberForJson(kpiIst['N. Post']),
          "Visualizzazione post istituzionali": formatNumberForJson(kpiIst['Visualizzazioni']),
          "Like + interazoni post istituzionali": formatNumberForJson(kpiIst['Interazioni'] + kpiIst['Like/Reazioni'])
      };

      // 4. CANALI
      const channels = [...new Set(filtered.map(r => r.Canale.trim().toLowerCase()))];
      const chanCard = document.createElement('div'); chanCard.className='card';
      chanCard.innerHTML = `<h2><i class="fas fa-filter"></i> Dettaglio per Canale</h2>`;
      const selDiv = document.createElement('div'); selDiv.className='channel-selector';
      selDiv.innerHTML = '<select id="chan-sel" style="padding:10px; font-size:1rem; border-radius:5px;"><option value="">-- Seleziona Canale --</option></select>';
      channels.forEach(c => {
          const opt = document.createElement('option'); opt.value=c; opt.textContent=c.toUpperCase();
          selDiv.querySelector('select').appendChild(opt);
      });
      chanCard.appendChild(selDiv);
      const chanContent = document.createElement('div'); chanContent.style.marginTop='1.5rem';
      chanCard.appendChild(chanContent);
      selDiv.querySelector('select').addEventListener('change', (e) => {
          const c = e.target.value; chanContent.innerHTML=''; if(!c) return;
          const posts = filtered.filter(r=>r.Canale.trim().toLowerCase()===c);
          renderChannelTable(posts, chanContent, c);
      });
      tabs.chan.appendChild(chanCard);
    }

    function renderChannelTable(posts, container, channelName) {
        const createSec = (title, metric, iconClass) => {
            const wrap = document.createElement('div'); wrap.style.marginBottom='2.5rem';
            const sorted = [...posts].sort((a,b)=>(Number(b[metric])||0)-(Number(a[metric])||0));
            
            const headDiv = document.createElement('div'); headDiv.style.display='flex'; headDiv.style.justifyContent='space-between'; headDiv.style.alignItems='center';
            headDiv.innerHTML = `<h3><i class="${iconClass}"></i> ${title}</h3>`;
            
            const btnEx = document.createElement('button'); btnEx.className='save-channel-table'; btnEx.innerHTML='<i class="fas fa-file-excel"></i> Scarica Excel';
            btnEx.onclick = () => {
                const ws = XLSX.utils.json_to_sheet(sorted.map(r=>({Label:r.Label, Arg:r.Argomento, Data:formatDate(r.Data), Copy:r.Copy, Vis:r.Visualizzazioni, Int:r.Interazioni, Link:r.Link})));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Dati');
                XLSX.writeFile(wb, `${channelName}_${metric}.xlsx`);
            };
            headDiv.appendChild(btnEx); wrap.appendChild(headDiv);

            const tblDiv = document.createElement('div'); tblDiv.className='table-wrapper';
            const tbl = document.createElement('table');
            tbl.innerHTML = `<thead><tr><th>Label</th><th>Argomento</th><th>Data</th><th>Copy</th><th>Vis.</th><th>Int.</th><th>Link</th></tr></thead><tbody></tbody>`;
            
            let limit = 5;
            const renderRows = () => {
                tbl.querySelector('tbody').innerHTML = '';
                sorted.slice(0, limit).forEach(r => {
                    const tr = document.createElement('tr');
                    const visF = formatNumber(r.Visualizzazioni);
                    const intF = formatNumber(r.Interazioni);
                    const label = r.Label || '';
                    const arg = r.Argomento || '';
                    const date = formatDate(r.Data);
                    
                    const copyFull = r.Copy || '';
                    const copyDisplay = copyFull.length > 40 ? copyFull.substring(0,40) + '...' : copyFull;

                    // Creazione celle
                    [[label,label], [arg,arg], [date,date], [copyDisplay,copyFull], [visF,visF], [intF,intF]].forEach(([disp, raw]) => {
                        const td = document.createElement('td'); 
                        td.textContent = disp; 
                        td.appendChild(createCopyBtn(raw)); 
                        tr.appendChild(td);
                    });
                    
                    tr.innerHTML += `<td><a href="${r.Link}" target="_blank" class="link-btn"><i class="fas fa-link"></i></a></td>`;
                    tbl.querySelector('tbody').appendChild(tr);
                });
            };
            renderRows();
            tblDiv.appendChild(tbl); wrap.appendChild(tblDiv);

            if(sorted.length > 5) {
                const ctrls = document.createElement('div'); ctrls.style.marginTop='10px'; ctrls.style.display='flex'; ctrls.style.gap='10px';
                const btnMore = document.createElement('button'); btnMore.className='save-table'; btnMore.style.background='#ecf0f1'; btnMore.textContent = `Mostra altri 10`;
                const btnAll = document.createElement('button'); btnAll.className='save-table'; btnAll.style.background='#ecf0f1'; btnAll.textContent = `Mostra tutti (${sorted.length})`;
                btnMore.onclick = () => { limit += 10; renderRows(); if(limit>=sorted.length) ctrls.style.display='none'; };
                btnAll.onclick = () => { limit = sorted.length; renderRows(); ctrls.style.display='none'; };
                ctrls.appendChild(btnMore); ctrls.appendChild(btnAll); wrap.appendChild(ctrls);
            }
            container.appendChild(wrap);
        };
        createSec('Top per Visualizzazioni', 'Visualizzazioni', 'fas fa-eye');
        createSec('Top per Interazioni', 'Interazioni', 'fas fa-thumbs-up');
    }
  </script>
</body>
</html>
