<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Social Report Unificata</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    /* --- FONT ORIGINALE (VISIBILE NEL BROWSER) --- */
    @font-face {
        font-family: 'Avenir Next LT Pro';
        src: url('https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2') format('woff2');
        font-weight: normal;
    }

    :root {
      /* Colori App Base */
      --primary: #00529F;
      --primary-hover: #003e7e;
      --bg: #f4f6f8;
      --text: #2c3e50;
      --text-light: #607d8b;
      --card-bg: #fff;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
      
      /* Variabili per Grafici D3 (App 2) */
      --chart-font: 'Nunito Sans', sans-serif;
      --header-total-grey: #3a3a3a;
      --chart-text-grey: #7b7b7a;
      --chart-title-blue: #0431AE;
      --chart-bar-blue: #bfd7fd;

      /* Variabili Grafici Istituzionali */
      --inst-blue: #1b47b4;
      --inst-yellow: #ffcc00;
      --inst-border: #ddd;
    }
    
    body { 
      margin: 0; 
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      font-size: 15px; 
      line-height: 1.5; 
    }
    
    /* Header */
    header { 
      background: var(--primary); 
      color: #fff; 
      padding: 1rem 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    
    .header-actions { display: flex; gap: 10px; }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
    
    /* Area Upload */
    .upload-area {
      background: var(--card-bg);
      border: 3px dashed #cbd5e0;
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
    .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .upload-text { font-size: 1.1rem; color: var(--text-light); font-weight: 500; }
    .upload-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; display: block; }

    /* Tabs */
    .tabs-header { display: flex; gap: 10px; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; }
    .tab-btn {
      padding: 10px 20px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.95rem;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .tabs-container { display: none; }
    .tab-content { display: none; animation: fadeIn 0.4s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Buttons */
    .btn-header { 
      border: none; padding: 8px 16px; 
      border-radius: 6px; font-weight: 600; cursor: pointer; display: none; font-size: 0.9rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: white;
    }
    #json-exec-btn { background-color: #27ae60; }
    #json-exec-btn:hover { background-color: #219150; }

    .action-btn {
        background-color: #fff; border: 1px solid #d1d5db; color: #4b5563;
        padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .action-btn:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }
    .action-btn.excel { color: #166534; border-color: #86efac; background: #f0fdf4; }
    .action-btn.excel:hover { background: #dcfce7; }
    .action-btn.yellow { color: #b7950b; border-color: #f1c40f; background: #fef9e7; }
    .action-btn.yellow:hover { background: #fcf3cf; }
    .action-btn.blue-fill { background-color: var(--primary); color: white; border: none; }
    .action-btn.blue-fill:hover { background-color: var(--primary-hover); }
    .action-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

    /* Cards e Layout Gen */
    .card { background: var(--card-bg); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid #e1e4e8; }
    .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.8rem; margin-bottom: 1.5rem; }
    .card h2 { margin: 0; color: var(--primary); font-size: 1.2rem; }
    .card-actions { display: flex; gap: 10px; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
    .stat-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: var(--border-radius);
      padding: 1rem; position: relative; border-left: 4px solid #ddd;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); border-left-color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; }
    .stat-label i { font-size: 1.2rem; color: var(--primary); }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--text); display: flex; align-items: center; justify-content: space-between; }

    /* Tabelle Generiche */
    .table-header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .table-wrapper { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #f8fafc; color: #4a5568; font-weight: 700; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
    td { padding: 12px; border-bottom: 1px solid #edf2f7; vertical-align: middle; font-size: 0.9rem; }
    tr:hover td { background-color: #f7fafc; }
    /* Totale tabella */
    tfoot tr { background-color: #eff6ff; font-weight: bold; border-top: 2px solid #cbd5e0; }
    tfoot td { color: var(--primary); }

    /* Accordion */
    details.accordion-item {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 1rem;
        background: #fff;
        overflow: hidden;
    }
    details.accordion-item summary {
        background: #f8fafc;
        padding: 1rem;
        font-weight: 600;
        cursor: pointer;
        outline: none;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text);
    }
    details.accordion-item summary::-webkit-details-marker { display: none; }
    details.accordion-item summary::after {
        content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900; transition: transform 0.2s;
    }
    details.accordion-item[open] summary::after { transform: rotate(180deg); }
    details.accordion-item[open] summary { border-bottom: 1px solid #e2e8f0; color: var(--primary); }
    .accordion-content { padding: 1.5rem; animation: fadeIn 0.3s ease; }

    /* Nested Accordion (Tables) */
    .nested-accordion { margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 6px; }
    .nested-accordion summary { background: #fff; font-size: 0.9rem; color: #555; padding: 10px; }
    .nested-accordion[open] summary { border-bottom: 1px solid #eee; color: var(--primary); }
    .nested-content { padding: 15px; background: #fafafa; }

    /* Post Cards */
    .post-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .post-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s; overflow: hidden;
    }
    .post-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-color: #cbd5e0; }
    .post-header { padding: 12px 16px; background: #fdfdfd; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; gap: 12px; }
    .post-channel-icon { font-size: 24px; color: var(--primary); margin-top: 2px; }
    .post-meta { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .post-label { font-weight: 700; color: #2d3748; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; text-transform: uppercase; }
    .post-date { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 6px; }
    .post-body { padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .post-topic { display: inline-flex; align-items: center; gap: 6px; background: #eef2f7; color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; align-self: flex-start; }
    .post-text { font-size: 0.95rem; color: #4a5568; white-space: pre-wrap; background: #fff; line-height: 1.5; position: relative; max-height: 150px; overflow-y: auto; }
    .post-footer { padding: 12px 16px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; }
    .post-metrics { display: flex; gap: 15px; }
    .metric-item { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 600; color: #4a5568; }
    .metric-item i { color: #a0aec0; }
    .metric-item.views i { color: #3498db; }
    .metric-item.likes i { color: #e74c3c; }
    .post-link-btn { color: #718096; transition: color 0.2s; font-size: 1.1rem; }
    .post-link-btn:hover { color: var(--primary); }
    .post-actions-right { display: flex; gap: 8px; }

    /* Grafici D3 (Ripristinati Originali) */
    .charts-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-wrapper {
        position: relative; background-color: #fff; border-radius: var(--border-radius);
        box-shadow: var(--shadow); padding: 10px; height: auto;
        display: flex; flex-direction: column; border: 1px solid #e2e8f0;
    }
    /* SVG Risponde al ViewBox */
    .chart-wrapper svg { width: 100%; height: auto; font-family: var(--chart-font); }
    
    .chart-buttons { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10; }
    .chart-btn {
      background: #f5f5f5; border: none; border-radius: 50%; width: 32px; height: 32px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background 0.3s; position: relative;
    }
    .chart-btn:hover { background: #e0e0e0; }
    .tooltip-chart { position: absolute; top: -32px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
    .tooltip-chart.show { opacity: 1; }
    
    .panels-row { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 0; }
    .panel-col { flex: 1; min-width: 300px; }

    /* Utils */
    .copy-btn { background: transparent; color: #cbd5e0; border: none; padding: 2px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; opacity: 0.6; }
    .copy-btn:hover { color: var(--primary); transform: scale(1.15); opacity: 1; }
    .save-table { background: #f1c40f; color: #333; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; display: inline-flex; gap: 6px; align-items: center; }
    .save-table:hover { background: #d4ac0d; }

    /* Toast */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 24px; color: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    .toast.warning { background: #f39c12; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    #chan-sel-container { margin-bottom: 1.5rem; }
    #chan-sel { padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; max-width: 300px; background: #fff; }

    .feed-controls { display: flex; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px; }
    .feed-sort-group { display: flex; gap: 5px; }

    /* --- STILI SPECIFICI GRAFICI ISTITUZIONALI --- */
    .inst-chart-container-wrapper {
        margin-top: 20px; margin-bottom: 30px;
        background-color: #fff; border: 1px solid #e2e8f0;
        border-radius: var(--border-radius); padding: 15px; box-shadow: var(--shadow);
    }
    .inst-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .inst-chart-title { font-weight: 700; color: var(--inst-blue); font-size: 1.1rem; }
    .inst-chart-controls { display: flex; gap: 10px; }
    .chart-container-inst { border: 1px solid var(--inst-border); border-radius: var(--border-radius); overflow: hidden; background-color: #fcfcfc; display: flex; justify-content: center; }
    .chart-container-inst svg { max-width: 100%; height: auto; display: block; background-color: white; }

    /* --- STILI MODALI --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
        background: #fff; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
    }
    .modal-header { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .modal-row { margin-bottom: 15px; }
    .modal-row label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
    .modal-row textarea, .modal-row input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; resize: vertical; box-sizing: border-box; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .close-modal { cursor: pointer; background: none; border: none; font-size: 1.2rem; color: #999; }

    /* --- STILI SPECIFICI MODALE GRAFICA POST (NUOVO) --- */
    .post-graph-modal-content {
        max-width: 1100px;
        display: flex; flex-direction: column; height: 85vh;
    }
    .split-modal { display: flex; gap: 20px; flex: 1; overflow: hidden; }
    .split-left { flex: 1; overflow-y: auto; padding-right: 10px; }
    .split-right { flex: 2; background: #eef2f5; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #dee2e6; overflow: hidden; padding: 10px; }
    .split-right svg { max-width: 100%; height: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; }

    /* --- NUOVO CSS PER ANALISI LABEL --- */
    .tables-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
    /* Nuova classe per colonna di analisi (tabella + grafico) */
    .analysis-column { flex: 1; min-width: 400px; display: flex; flex-direction: column; gap: 20px; }
    
    .table-col { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--shadow); }
    .label-chart-wrapper { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: var(--shadow); position: relative; }
    .label-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .label-chart-title { font-size: 1.2rem; color: var(--primary); font-weight: 700; font-family: 'Avenir Next LT Pro', sans-serif; }

    /* --- CSS PER CONTROLLI GRAFICO (SLIDER) --- */
    .chart-controls-row {
        padding: 10px 0;
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 20px;
        background: #fcfcfc;
        border-bottom: 1px solid #eee;
    }
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .control-group label {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        width: 200px;
    }
    .range-slider {
        width: 200px;
        cursor: pointer;
    }
    .slider-val {
        color: #555;
        font-weight: normal;
    }

    /* --- NUOVI STILI FILTRI GLOBALI --- */
    .filters-card { background: #fff; border: 2px solid var(--primary); border-radius: var(--border-radius); margin-bottom: 2rem; overflow: hidden; box-shadow: var(--shadow); }
    .filters-header { background: var(--primary); color: white; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
    .filters-body { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; background: #fcfcfc; align-items: flex-start; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    .filter-group label { font-weight: 700; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
    .filter-group select, .filter-group input { padding: 8px; border: 1px solid #cbd5e0; border-radius: 6px; font-family: inherit; }
    .filter-actions { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 10px; padding-top: 10px; border-top: 1px solid #eee; }
    .multiselect-container { border: 1px solid #cbd5e0; border-radius: 6px; background: white; max-height: 120px; overflow-y: auto; padding: 5px; }
    .multiselect-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; padding: 2px 0; cursor: pointer; }
    .multiselect-item input { cursor: pointer; }

  </style>
</head>
<body>

  <div class="modal-overlay" id="editModal">
      <div class="modal-content">
          <div class="modal-header">
              <span>Modifica Testi Grafico (Best Performers)</span>
              <button class="close-modal" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
          </div>
          <div id="modal-body-inputs"></div>
          <div class="modal-footer">
              <button class="action-btn" onclick="closeEditModal()">Annulla</button>
              <button class="action-btn active" onclick="saveModalChanges()">Applica e Rigenera</button>
          </div>
      </div>
  </div>

  <div class="modal-overlay" id="postGraphModal">
      <div class="modal-content post-graph-modal-content">
          <div class="modal-header">
              <span><i class="fas fa-palette"></i> Generatore Grafico Post</span>
              <button class="close-modal" onclick="closePostGraphModal()"><i class="fas fa-times"></i></button>
          </div>
          <div class="split-modal">
            <div class="split-left">
                <div class="modal-row">
                    <label>Argomento (Editabile)</label>
                    <input type="text" id="pg-argomento" oninput="updatePostSvg()">
                </div>
                <div class="modal-row">
                    <label>Copy (Editabile - Max 3 righe nel grafico)</label>
                    <textarea id="pg-copy" rows="5" oninput="updatePostSvg()"></textarea>
                </div>
                <div class="modal-row">
                    <label>Visualizzazioni</label>
                    <input type="text" id="pg-views" disabled style="background:#f0f0f0">
                </div>
                <div class="modal-row">
                    <label>Interazioni</label>
                    <input type="text" id="pg-inter" disabled style="background:#f0f0f0">
                </div>
                <div class="modal-row">
                    <label>Dettagli (Sola Lettura)</label>
                    <input type="text" id="pg-info" disabled style="background:#f0f0f0; font-size:0.85em;">
                </div>
            </div>
            <div class="split-right" id="pg-preview-container">
                </div>
          </div>
          <div class="modal-footer">
              <button class="action-btn yellow" onclick="downloadPostSvg()"><i class="fas fa-download"></i> Scarica SVG</button>
              <button class="action-btn active" onclick="copyPostSvg()"><i class="far fa-copy"></i> Copia HQ (4x)</button>
          </div>
      </div>
  </div>

  <header>
    <h1><i class="fas fa-chart-line"></i> Dashboard Report Social Unificata <span style="font-size:0.6em; opacity:0.8; margin-left:10px; font-weight:300;">v2.0</span></h1>
    <div class="header-actions">
        <button id="json-exec-btn" class="btn-header"><i class="fas fa-file-contract"></i> JSON Executive</button>
    </div>
  </header>
  
  <div id="toast-container"></div>

  <div class="container">
    <div class="upload-area" id="upload-box">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <span class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></span>
      <div class="upload-text" id="upload-label">Trascina il file Excel qui o clicca per caricare</div>
    </div>

    <div id="global-filters-area" style="display:none;">
        <div class="filters-card">
            <div class="filters-header" onclick="document.getElementById('filters-content').style.display = document.getElementById('filters-content').style.display === 'none' ? 'grid' : 'none'">
                <span><i class="fas fa-filter"></i> STRUMENTI DI ANALISI E FILTRI AVANZATI</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="filters-body" id="filters-content" style="display:none;">
                <div class="filter-group">
                    <label><i class="fas fa-calendar-alt"></i> Date Custom</label>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <input type="date" id="filter-date-start" onchange="applyGlobalFilters()">
                        <input type="date" id="filter-date-end" onchange="applyGlobalFilters()">
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-calendar-check"></i> Per Mesi</label>
                    <div id="filter-months-list" class="multiselect-container" style="max-height: 100px;">
                        </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-layer-group"></i> Canali</label>
                    <div id="filter-channels-list" class="multiselect-container" style="max-height: 100px;">
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-search"></i> Cerca Argomenti</label>
                    <input type="text" id="filter-topic-search" placeholder="Filtra argomenti..." oninput="updateTopicList()" style="margin-bottom:5px;">
                    <div id="filter-topics-list" class="multiselect-container" style="max-height: 100px;">
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-tag"></i> Label</label>
                    <div id="filter-labels-list" class="multiselect-container" style="max-height: 100px;">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="action-btn" onclick="resetGlobalFilters()"><i class="fas fa-undo"></i> Reset</button>
                    <button class="action-btn blue-fill" onclick="applyGlobalFilters()"><i class="fas fa-sync"></i> Aggiorna Analisi</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('tab-overview')"><i class="fas fa-home"></i> Panoramica</button>
        <button class="tab-btn" onclick="switchTab('tab-instit')"><i class="fas fa-building"></i> Istituzionale</button>
        <button class="tab-btn" onclick="switchTab('tab-labels')"><i class="fas fa-tag"></i> Analisi per Label</button>
        <button class="tab-btn" onclick="switchTab('tab-topics')"><i class="fas fa-tags"></i> Top Argomenti</button>
        <button class="tab-btn" onclick="switchTab('tab-channels')"><i class="fas fa-share-alt"></i> Canali</button>
      </div>

      <div id="tab-overview" class="tab-content active"></div>
      <div id="tab-instit" class="tab-content"></div>
      <div id="tab-labels" class="tab-content"></div>
      <div id="tab-topics" class="tab-content"></div>
      <div id="tab-channels" class="tab-content"></div>
    </div>
  </div>

  <script>
    // --- VARIABILI & CONFIG ---
    const fileInput = document.getElementById('file-input');
    const uploadLabel = document.getElementById('upload-label');
    const jsonExecBtn = document.getElementById('json-exec-btn');
    const mainContent = document.getElementById('main-content');
    let workbookData = null;
    let rawData = [];         // Dati originali dall'Excel
    let filteredData = [];    // Dati filtrati per "Editoriale"
    let displayData = [];     // Dati attualmente visualizzati (dopo i filtri utente)
    let cols = {};
    
    // Stato Filtri
    let activeFilters = {
        topics: [],
        channels: [],
        labels: [],
        months: [],
        dateStart: null,
        dateEnd: null
    };
    let currentTop5Data = []; 
    let currentPostData = {};

    // --- LOGICA FILTRI AVANZATI ---
    function populateFilterUI() {
        const topics = [...new Set(filteredData.map(r => r[cols.arg] || 'Generale'))].sort();
        const channels = [...new Set(filteredData.map(r => String(r[cols.canale]).toLowerCase()))].sort();
        const labels = [...new Set(filteredData.map(r => r[cols.label] || 'Nessuna'))].sort();
        
        // Estrazione Mesi Unici dai dati
        const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
        const monthsMap = {};
        filteredData.forEach(r => {
            const d = new Date(formatDateForCompare(r[cols.data]));
            if(!isNaN(d)) {
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
                monthsMap[key] = label;
            }
        });
        const sortedMonthsKeys = Object.keys(monthsMap).sort().reverse();
        const monthsList = sortedMonthsKeys.map(k => ({ val: k, label: monthsMap[k] }));

        renderCheckboxList('filter-topics-list', topics, 'topics');
        renderCheckboxList('filter-channels-list', channels, 'channels');
        renderCheckboxList('filter-labels-list', labels, 'labels');
        
        // Render Listato Mesi
        const mCon = document.getElementById('filter-months-list');
        if(mCon) {
            mCon.innerHTML = monthsList.map(m => `
                <div class="multiselect-item">
                    <input type="checkbox" value="${m.val}" data-type="months" onchange="updateFilterState(this)">
                    <span>${m.label}</span>
                </div>
            `).join('');
        }
        
        document.getElementById('global-filters-area').style.display = 'block';
    }

    function renderCheckboxList(containerId, items, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = items.map(item => `
            <div class="multiselect-item">
                <input type="checkbox" value="${item}" data-type="${type}" onchange="updateFilterState(this)">
                <span>${item}</span>
            </div>
        `).join('');
    }

    window.updateTopicList = function() {
        const search = document.getElementById('filter-topic-search').value.toLowerCase();
        const items = document.querySelectorAll('#filter-topics-list .multiselect-item');
        items.forEach(it => {
            const txt = it.innerText.toLowerCase();
            it.style.display = txt.includes(search) ? 'flex' : 'none';
        });
    }

    window.updateFilterState = function(el) {
        const val = el.value;
        const type = el.getAttribute('data-type');
        if(el.checked) {
            if(!activeFilters[type].includes(val)) activeFilters[type].push(val);
        } else {
            activeFilters[type] = activeFilters[type].filter(v => v !== val);
        }
        applyGlobalFilters();
    }

    window.applyGlobalFilters = function() {
        const start = document.getElementById('filter-date-start').value;
        const end = document.getElementById('filter-date-end').value;

        displayData = filteredData.filter(r => {
            const rDateStr = formatDateForCompare(r[cols.data]);
            
            // 1. Filtro Data Granulare
            if(start || end) {
                if(start && rDateStr < start) return false;
                if(end && rDateStr > end) return false;
            }
            
            // 2. Filtro per Mesi Selezionati
            if(activeFilters.months.length > 0) {
                const rMonthKey = rDateStr.substring(0, 7); // YYYY-MM
                if(!activeFilters.months.includes(rMonthKey)) return false;
            }
            
            // 3. Filtro Argomenti
            if(activeFilters.topics.length > 0 && !activeFilters.topics.includes(r[cols.arg] || 'Generale')) return false;
            // 4. Filtro Canali
            if(activeFilters.channels.length > 0 && !activeFilters.channels.includes(String(r[cols.canale]).toLowerCase())) return false;
            // 5. Filtro Label
            if(activeFilters.labels.length > 0 && !activeFilters.labels.includes(r[cols.label] || 'Nessuna')) return false;
            
            return true;
        });

        renderAll(displayData);
    }

    function formatDateForCompare(t) {
        if(!t) return '';
        let dateObj;
        
        if (t instanceof Date) {
            dateObj = t;
        } else if (typeof t === 'number') {
            // Converte seriale Excel in oggetto Date JS
            dateObj = new Date((t - 25569) * 86400 * 1000);
        } else {
            // Gestione stringhe DD/MM/YYYY o DD/MM/YY
            if(/^\d{2}\/\d{2}\/\d{2,4}$/.test(t)) {
                const parts = t.split('/');
                const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                return `${y}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
            dateObj = new Date(t);
        }

        if(!isNaN(dateObj.getTime())) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        return '';
    }

    window.resetGlobalFilters = function() {
        activeFilters = { topics: [], channels: [], labels: [], months: [], dateStart: null, dateEnd: null };
        document.querySelectorAll('.multiselect-container input').forEach(i => i.checked = false);
        document.getElementById('filter-date-start').value = '';
        document.getElementById('filter-date-end').value = '';
        document.getElementById('filter-topic-search').value = '';
        updateTopicList();
        displayData = [...filteredData];
        renderAll(displayData);
    }

    // --- UTILS ORIGINALI ---
    function showToast(msg, type) {
        const c = document.getElementById('toast-container');
        const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-exclamation-circle"></i>');
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `${icon} ${msg}`;
        c.appendChild(t); setTimeout(() => t.remove(), 4000);
    }

    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const buttons = document.querySelectorAll('.tab-btn');
        const map = {'tab-overview':0, 'tab-instit':1, 'tab-labels':2, 'tab-topics':3, 'tab-channels':4};
        if(map[tabId] !== undefined) buttons[map[tabId]].classList.add('active');
    }

    // --- COPY & EXPORT HELPERS ---
    function formatNumberInstChart(num) {
        const numericValue = Number(num);
        if (isNaN(numericValue)) return num;
        if (numericValue >= 1000000) return (numericValue / 1000000).toFixed(1).replace('.', ',') + 'M';
        if (numericValue >= 1000) return Math.round(numericValue / 1000).toString() + 'K';
        return numericValue.toString();
    }
    
    function downloadSvgDirect(svgElement, filename) {
        if (!svgElement) return;
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);
        if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        // Qui per il download diretto (file) possiamo mantenere i font esterni
        source = source.replace('>', '><style>@font-face { font-family: "Avenir Next LT Pro"; src: url("https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2") format("woff2"); } @font-face { font-family: "Arial"; src: local("Arial"); }</style>');

        const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /* --- COPIA ALTA RISOLUZIONE (4X) + FIX FIREFOX/LOCAL FILE --- */
    function copySvgHighRes(svgElement) {
        if (!svgElement) return;
        
        showToast("Elaborazione immagine...", "warning");

        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);
        
        // Assicuriamoci del namespace
        if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        
        // --- FIX CRITICO PER FIREFOX E BLOCCHI CORS ---
        const safeFontStyle = `<style>
            text, tspan { font-family: "Segoe UI", "Arial", sans-serif !important; }
        </style>`;
        
        // Inseriamo lo stile sicuro
        if (source.indexOf('>') > -1) {
             source = source.substring(0, source.indexOf('>') + 1) + safeFontStyle + source.substring(source.indexOf('>') + 1);
        }

        const scaleFactor = 4;
        const viewBox = svgElement.getAttribute('viewBox').split(' ');
        const w = parseFloat(viewBox[2]);
        const h = parseFloat(viewBox[3]);
        
        const canvas = document.createElement('canvas');
        canvas.width = w * scaleFactor;
        canvas.height = h * scaleFactor;
        const ctx = canvas.getContext('2d');
        
        const img = new Image();
        const svgBlob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        
        img.onload = function() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            canvas.toBlob(function(blob) {
                // TENTATIVO DI COPIA
                if (navigator.clipboard && navigator.clipboard.write) {
                    navigator.clipboard.write([new ClipboardItem({'image/png': blob})])
                    .then(() => {
                         showToast('Copiato con successo! Incolla su PowerPoint.', 'success'); 
                    })
                    .catch((err) => {
                        console.error("Copia fallita (probabile blocco file locale):", err);
                        // FALLBACK: SCARICA L'IMMAGINE
                        downloadBlob(blob, "grafico-copia-fallback.png");
                        showToast('Copia bloccata dal browser -> Immagine scaricata!', 'warning');
                    });
                } else {
                    // FALLBACK SE CLIPBOARD API NON ESISTE
                    downloadBlob(blob, "grafico-copia-fallback.png");
                    showToast('Copia non supportata -> Immagine scaricata!', 'warning');
                }
                URL.revokeObjectURL(url);
            }, 'image/png');
        };

        img.onerror = function() {
            showToast("Errore rendering immagine (Security Block)", "error");
            console.error("Errore caricamento immagine SVG nel Canvas. Probabile causa: Font esterni o risorse cross-origin in ambiente locale.");
            URL.revokeObjectURL(url);
        };

        img.src = url;
    }

    function downloadBlob(blob, filename) {
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function copyTable(tableEl) {
        if(!tableEl) return;
        let txt = "";
        const headers = Array.from(tableEl.querySelectorAll("thead th")).map(th => th.textContent.trim());
        txt += headers.join("\t") + "\n";
        const rows = tableEl.querySelectorAll("tbody tr");
        rows.forEach(tr => {
            const cells = Array.from(tr.querySelectorAll("td")).map(td => td.innerText.replace(/content_copy|Copiato!/g, '').trim());
            txt += cells.join("\t") + "\n";
        });
        navigator.clipboard.writeText(txt).then(() => showToast("Tabella copiata!", "success"));
    }
    function createTableCopyBtn(tableEl) {
        const btn = document.createElement('button'); btn.className = 'action-btn';
        btn.innerHTML = '<i class="far fa-copy"></i> Copia Tabella'; btn.onclick = () => copyTable(tableEl);
        return btn;
    }

    // --- DATA PARSING ---
    const findCol = (regex, firstRow) => Object.keys(firstRow || {}).find(h => new RegExp(regex, 'i').test(h));

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      uploadLabel.innerHTML = `⏳ Elaborazione di <strong>${file.name}</strong>...`;
      const reader = new FileReader();
      
      reader.onload = evt => {
        try {
            workbookData = XLSX.read(new Uint8Array(evt.target.result), { type: 'array', cellDates: true });
            rawData = XLSX.utils.sheet_to_json(workbookData.Sheets[workbookData.SheetNames[0]], { defval: '' });
            if (rawData.length > 0) {
                cols = {
                    data: findCol('dat', rawData[0]),
                    canale: findCol('canal', rawData[0]),
                    vis: findCol('visualizz', rawData[0]),
                    inter: findCol('interaz', rawData[0]),
                    label: findCol('label', rawData[0]),
                    campagna: findCol('campagn', rawData[0]),
                    arg: findCol('argoment', rawData[0]) || 'Argomento',
                    copy: findCol('copy', rawData[0]) || 'Copy',
                    link: findCol('link', rawData[0]) || 'Link',
                    like: findCol('like', rawData[0]) || 'Like e reazioni',
                    cond: findCol('condivisioni', rawData[0]) || 'Condivisioni',
                    istituzionale: findCol('istituzionale', rawData[0])
                };
            }
            if (!cols.campagna) throw new Error("Colonna Campagna non trovata");
            filteredData = rawData.filter(r => String(r[cols.campagna]).trim().toLowerCase() === 'editoriale');
            displayData = [...filteredData];
            populateFilterUI();
            renderAll(displayData);
            mainContent.style.display = 'block'; jsonExecBtn.style.display = 'inline-block';
            uploadLabel.innerHTML = `✅ <strong>${file.name}</strong> caricato con successo.`;
            showToast('Dati elaborati correttamente', 'success');
        } catch (err) {
            console.error(err); uploadLabel.innerHTML = `❌ Errore nel file: ${err.message}`; showToast('Errore lettura file Excel', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    function renderAll(data) {
        renderOverview(data); renderInstitutional(data); renderLabels(data); renderTopics(data); renderChannels(data);
    }

    // --- HELPERS FORMATTAZIONE ---
    function formatDate(t) { if(!t) return ''; let d,m,y; if(/^\d{4}-\d{2}-\d{2}$/.test(t))[y,m,d]=t.split('-'); else if(/^\d{2}\/\d{2}\/\d{4}$/.test(t))[d,m,y]=t.split('/'); else{const dt=new Date(t);if(!isNaN(dt)){d=dt.getDate();m=dt.getMonth()+1;y=dt.getFullYear();}else return t;} return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y.toString().slice(-2)}`; }
    function formatNumber(n) { n=Number(n)||0; if(n<1000)return n.toString(); if(n<1000000)return `${Math.round(n/1000)}K`; return `${(n/1000000).toFixed(2).replace('.',',')}M`; }
    function formatNumberForJson(n) { let v=Number(n)||0; if(v>=1000000)return (v/1000000).toFixed(2).replace('.',',')+"M"; if(v>=1000)return Math.round(v/1000)+"K"; return v.toString().replace('.',','); }
    function formatKValue(num) { num = +num || 0; if (num >= 1000000) return parseFloat((num/1000000).toFixed(2)).toString().replace('.', ',') + 'M'; if (num >= 1000) return Math.round(num/1000).toString() + 'K'; return num.toString(); }
    function formatNumberItalian(num) { return (+num || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function formatNumberFull(num) {
        if (typeof num !== 'number') { num = parseFloat(num); if (isNaN(num)) return ''; }
        if (num >= 1000000) return (num / 1000000).toFixed(1).replace('.', ',') + 'M';
        else if (num >= 1000) return (num / 1000).toFixed(1).replace('.', ',') + 'K';
        return num.toString().replace('.', ',');
    }
    
    // NUOVA FUNZIONE DI FORMATTAZIONE SMART RICHIESTA (K/M con decimali puliti)
    function formatSmartKM(num) {
        num = Number(num) || 0;
        if (num < 1000) return formatNumberItalian(num);
        
        let val, suffix;
        if (num >= 1000000) {
            val = num / 1000000;
            suffix = 'M';
        } else {
            val = num / 1000;
            suffix = 'K';
        }
        
        // 2 cifre decimali, sostituisci punto con virgola
        let str = val.toFixed(2).replace('.', ',');
        
        // Rimuovi decimali inutili:
        // ,00 -> stringa vuota
        // ,50 -> ,5
        str = str.replace(/,00$/, '').replace(/,(\d)0$/, ',$1');
        
        return str + suffix;
    }
    
    // NUOVA FUNZIONE PER GESTIRE I DECIMALI SELEZIONABILI NEI GRAFICI LABEL
    function formatCustomDecimals(num, decimals) {
        num = Number(num) || 0;
        decimals = parseInt(decimals);
        if (isNaN(decimals)) decimals = 2; // default

        // Se numero piccolo (< 1000), mostra intero senza K/M
        if (num < 1000) return formatNumberItalian(num);
        
        let val, suffix;
        if (num >= 1000000) {
            val = num / 1000000;
            suffix = 'M';
        } else {
            val = num / 1000;
            suffix = 'K';
        }
        
        // Applica i decimali fissi richiesti, ma rimuovi gli zero inutili
        // Esempio: 1.0 -> 1, 1.50 -> 1.5, 1.00 -> 1
        let formatted = parseFloat(val.toFixed(decimals)).toString().replace('.', ',');

        return formatted + suffix;
    }

    function createCopyBtn(textToCopy) {
        const b = document.createElement('button'); b.className = 'copy-btn'; b.innerHTML = '<i class="far fa-copy"></i>';
        b.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(String(textToCopy)).then(() => { b.innerHTML = '<i class="fas fa-check"></i>'; b.style.color = '#27ae60'; setTimeout(() => { b.innerHTML = '<i class="far fa-copy"></i>'; b.style.color = ''; }, 1500); }); };
        return b;
    }
    function getChannelIcon(name) {
        const n = String(name).toLowerCase();
        if(n.includes('facebook')) return '<i class="fab fa-facebook"></i>';
        if(n.includes('instagram')) return '<i class="fab fa-instagram"></i>';
        if(n.includes('linkedin')) return '<i class="fab fa-linkedin"></i>';
        if(n.includes('twitter') || n.includes('x')) return '<i class="fa-brands fa-x-twitter"></i>'; 
        if(n.includes('youtube')) return '<i class="fab fa-youtube"></i>';
        if(n.includes('whatsapp')) return '<i class="fab fa-whatsapp"></i>';
        return '<i class="fas fa-share-alt"></i>';
    }

    // --- JSON EXECUTIVE (AGGIORNATO AL MODELLO RICHIESTO + NOME FILE DATA) ---
    jsonExecBtn.addEventListener('click', () => {
        if (!filteredData || filteredData.length === 0) { showToast("Nessun dato!", "error"); return; }
        const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
        filteredData.forEach(r => {
            const c = String(r[cols.canale]).toLowerCase();
            if(c.includes('facebook')) counts.fb++; else if(c.includes('twitter')||c.includes('x')) counts.tw++; 
            else if(c.includes('linkedin')) counts.li++; else if(c.includes('instagram')) counts.ig++; 
            else if(c.includes('youtube')) counts.yt++; else if(c.includes('whatsapp')) counts.wa++;
        });
        const topics = {};
        filteredData.forEach(r => { const a = r[cols.arg] || 'Altro'; if(!topics[a]) topics[a] = { arg: a, v: 0 }; topics[a].v += Number(r[cols.vis] || 0); });
        const sortedTopics = Object.values(topics).sort((a,b) => b.v - a.v).slice(0, 3);
        const colIst = findCol('istituzionale', rawData[0]) || 'Istituzionale';
        const instData = filteredData.filter(r => String(r[colIst]).trim() === '1');
        const instStats = { n: instData.length, v: instData.reduce((s,r) => s + (Number(r[cols.vis])||0), 0), i: instData.reduce((s,r) => s + (Number(r[cols.inter])||0) + (Number(r[cols.like])||0), 0) };
        
        // MODELLO JSON RICHIESTO (CORRETTO TYPO "interazoni" -> "interazioni")
        const customJson = {
            "__COMMENTO_SEZIONE_VOLUMI__": "--- AMBITO 2: Volumi Post ---",
            "Numero post Facebook": counts.fb.toString(),
            "Numero post Instagram": counts.ig.toString(),
            "Numero post Linkedin": counts.li.toString(),
            "Numero post X (Twitter)": counts.tw.toString(),
            "Numero post Whatsapp": counts.wa.toString(),
            "Numero post Youtube": counts.yt.toString(),
            
            "__COMMENTO_SEZIONE_BEST__": "--- AMBITO 3: Best Performer ---",
            "Argomenti più visualizzati 1": sortedTopics[0]?.arg || "",
            "Visualizzazione Argomenti più visualizzati 1": formatNumberForJson(sortedTopics[0]?.v || 0),
            "Argomenti più visualizzati 2": sortedTopics[1]?.arg || "",
            "Visualizzazione Argomenti più visualizzati 2": formatNumberForJson(sortedTopics[1]?.v || 0),
            "Argomenti più visualizzati 3": sortedTopics[2]?.arg || "",
            "Visualizzazione Argomenti più visualizzati 3": formatNumberForJson(sortedTopics[2]?.v || 0),
            
            "__COMMENTO_SEZIONE_ISTITUZIONALI__": "--- DATI ISTITUZIONALI ---",
            "Numero post istituzionali": instStats.n.toString(),
            "Visualizzazione post istituzionali": formatNumberForJson(instStats.v),
            "Like + interazioni post istituzionali": formatNumberForJson(instStats.i)
        };

        // NUOVA FORMATTAZIONE NOME FILE (ES2_YYYY_MM_DD_HH_MM_SS)
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const h = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        const s = String(d.getSeconds()).padStart(2, '0');
        const filename = `ES2_${y}_${m}_${day}_${h}_${min}_${s}.json`;

        const blob = new Blob([JSON.stringify(customJson, null, 2)], { type: "application/json" });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
        a.click();
    });

    // --- 1. OVERVIEW ---
    function renderOverview(data) {
        const container = document.getElementById('tab-overview'); container.innerHTML = '';
        const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
        data.forEach(r => { const c = String(r[cols.canale]).toLowerCase(); if(c.includes('facebook')) counts.fb++; else if(c.includes('instagram')) counts.ig++; else if(c.includes('whatsapp')) counts.wa++; else if(c.includes('twitter') || c.includes('x')) counts.tw++; else if(c.includes('linkedin')) counts.li++; else if(c.includes('youtube')) counts.yt++; });
        const totals = { 'Post Totali': {val: data.length, icon: '<i class="fas fa-layer-group"></i>'}, 'Facebook': {val: counts.fb, icon: getChannelIcon('facebook')}, 'Instagram': {val: counts.ig, icon: getChannelIcon('instagram')}, 'LinkedIn': {val: counts.li, icon: getChannelIcon('linkedin')}, 'X (Twitter)': {val: counts.tw, icon: getChannelIcon('x')}, 'YouTube': {val: counts.yt, icon: getChannelIcon('youtube')}, 'WhatsApp': {val: counts.wa, icon: getChannelIcon('whatsapp')} };
        
        const card = document.createElement('div'); card.className = 'card';
        const header = document.createElement('div'); header.className = 'card-header';
        header.innerHTML = '<h2><i class="fas fa-chart-pie"></i> Volumi di Pubblicazione</h2>';
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel';
        btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel';
        btnExp.onclick = () => { const ws = XLSX.utils.json_to_sheet(Object.entries(totals).map(([k, v]) => ({ "Metrica": k, "Valore": v.val }))); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Panoramica"); XLSX.writeFile(wb, "Panoramica.xlsx"); };
        header.appendChild(btnExp); card.appendChild(header);
        
        const grid = document.createElement('div'); grid.className = 'stats-grid';
        Object.entries(totals).forEach(([k, obj]) => { const sc = document.createElement('div'); sc.className = 'stat-card'; sc.innerHTML = `<span class="stat-label">${obj.icon} ${k}</span><div class="stat-value">${obj.val}</div>`; sc.querySelector('.stat-value').appendChild(createCopyBtn(obj.val)); grid.appendChild(sc); });
        card.appendChild(grid); container.appendChild(card);
    }

    // --- 2. ISTITUZIONALE (MODIFICATO LABEL "Numero post" + TABELLA/GRAFICO CONDIVISIONI) ---
    function renderInstitutional(data) {
        const container = document.getElementById('tab-instit'); container.innerHTML = '';
        const colIst = findCol('istituzionale', data[0]) || 'Istituzionale';
        const institData = data.filter(r => String(r[colIst]).trim() === '1');
        const agg={};
        // AGGIUNTA AGGREGAZIONE CONDIVISIONI (c)
        institData.forEach(r=>{ 
            const a=r[cols.arg]||'ND'; 
            if(!agg[a]) agg[a]={v:0, i:0, l:0, c:0, lnk:r[cols.link]}; 
            agg[a].v+=Number(r[cols.vis])||0; 
            agg[a].i+=Number(r[cols.inter])||0; 
            agg[a].l+=Number(r[cols.like])||0; 
            agg[a].c+=Number(r[cols.cond])||0;
        });
        currentTop5Data = Object.entries(agg).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,5);

        // Modifica: Chiave 'Numero post' invece di 'N. Post'
        const kpi = { 'Numero post': institData.length, 'Visualizzazioni': institData.reduce((s,r)=>s+(Number(r[cols.vis])||0),0), 'Interazioni': institData.reduce((s,r)=>s+(Number(r[cols.inter])||0),0), 'Like': institData.reduce((s,r)=>s+(Number(r[cols.like])||0),0) };
        
        const card = document.createElement('div'); card.className = 'card';
        const header = document.createElement('div'); header.className = 'card-header';
        header.innerHTML = '<h2><i class="fas fa-university"></i> KPI Istituzionali</h2>';
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel'; btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel'; btnExp.onclick = () => { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([kpi]), "KPI"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(currentTop5Data), "Top5"); XLSX.writeFile(wb, "Istituzionali.xlsx"); };
        header.appendChild(btnExp); card.appendChild(header);

        const grid = document.createElement('div'); grid.className = 'stats-grid';
        Object.entries(kpi).forEach(([k,v]) => { const sc = document.createElement('div'); sc.className = 'stat-card'; const fmt = formatNumber(v); sc.innerHTML = `<span class="stat-label">${k}</span><div class="stat-value">${fmt}</div>`; sc.querySelector('.stat-value').appendChild(createCopyBtn(fmt)); grid.appendChild(sc); });
        card.appendChild(grid);

        const tblDiv = document.createElement('div'); tblDiv.style.marginTop='2rem';
        const tblHead = document.createElement('div'); tblHead.className='table-header-actions';
        tblHead.innerHTML = '<h3><i class="fas fa-table"></i> Top 5 Performers</h3>';
        const tbl = document.createElement('table'); tblHead.appendChild(createTableCopyBtn(tbl)); tblDiv.appendChild(tblHead);
        
        // MODIFICA TABELLA: Aggiunto Condivisioni prima di Link
        tbl.innerHTML = '<thead><tr><th>Argomento</th><th>Visualizzazioni</th><th>Interazioni</th><th>Like</th><th>Condivisioni</th><th>Link</th></tr></thead><tbody></tbody>';
        currentTop5Data.forEach(o => { 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `<td>${o.arg}</td><td>${formatNumber(o.v)}</td><td>${formatNumber(o.i)}</td><td>${formatNumber(o.l)}</td><td>${formatNumber(o.c)}</td><td>${o.lnk?'<a href="'+o.lnk+'" target="_blank">link</a>':''}</td>`; 
            tbl.querySelector('tbody').appendChild(tr); 
        });
        const tw = document.createElement('div'); tw.className='table-wrapper'; tw.appendChild(tbl); tblDiv.appendChild(tw); card.appendChild(tblDiv);

        const editDiv = document.createElement('div'); editDiv.style.marginTop='2rem'; editDiv.style.textAlign='right';
        editDiv.innerHTML = `<button class="action-btn" onclick="openEditModal()"><i class="fas fa-pen"></i> Modifica Testi per Grafici</button>`;
        card.appendChild(editDiv);

        const chartsWrapper = document.createElement('div');
        chartsWrapper.innerHTML = `
            <div class="inst-chart-container-wrapper"><div class="inst-chart-header"><span class="inst-chart-title">Grafico Prestazioni</span><div class="inst-chart-controls" id="ctrl-chart-1"></div></div><div id="inst-chart-1" class="chart-container-inst"></div></div>
            <div class="inst-chart-container-wrapper"><div class="inst-chart-header"><span class="inst-chart-title">Grafico Best Performers</span><div class="inst-chart-controls" id="ctrl-chart-2"></div></div><div id="inst-chart-2" class="chart-container-inst"></div></div>
        `;
        card.appendChild(chartsWrapper); container.appendChild(card);
        renderChartsOnly(kpi, currentTop5Data);
    }

    function renderChartsOnly(kpi, top5) {
        // Chart 1 (Modifica: 'Numero post')
        const c1H = ["Numero post", "Visualizzazioni", "Interazioni", "Like"];
        const c1V = [kpi['Numero post'], kpi['Visualizzazioni'], kpi['Interazioni'], kpi['Like']];
        const con1 = document.getElementById('inst-chart-1'); con1.innerHTML='';
        const svg1 = renderInstSvgTop(c1H, c1V); con1.appendChild(svg1);
        const ctrl1 = document.getElementById('ctrl-chart-1'); ctrl1.innerHTML='';
        
        // MODIFICATO PER USARE copySvgHighRes
        const bC1 = document.createElement('button'); bC1.className='action-btn'; bC1.innerHTML='<i class="far fa-copy"></i> Copia HQ'; bC1.onclick=()=>copySvgHighRes(svg1);
        
        const bD1 = document.createElement('button'); bD1.className='action-btn yellow'; bD1.innerHTML='<i class="fas fa-download"></i> SVG'; bD1.onclick=()=>downloadSvgDirect(svg1,'grafico-1.svg');
        ctrl1.append(bC1, bD1);

        // Chart 2 (MODIFICA: SOSTITUITO LINK CON CONDIVISIONI)
        const c2H = ["Argomento", "Visualizzazioni", "Interazioni", "Like", "Condivisioni"];
        // Mappiamo i.c (condivisioni) al posto del link
        const c2R = top5.map(i => [i.arg, i.v, i.i, i.l, i.c]);
        const con2 = document.getElementById('inst-chart-2'); con2.innerHTML='';
        const svg2 = renderInstSvgBottom(c2H, c2R); con2.appendChild(svg2);
        const ctrl2 = document.getElementById('ctrl-chart-2'); ctrl2.innerHTML='';
        
        // MODIFICATO PER USARE copySvgHighRes
        const bC2 = document.createElement('button'); bC2.className='action-btn'; bC2.innerHTML='<i class="far fa-copy"></i> Copia HQ'; bC2.onclick=()=>copySvgHighRes(svg2);
        
        const bD2 = document.createElement('button'); bD2.className='action-btn yellow'; bD2.innerHTML='<i class="fas fa-download"></i> SVG'; bD2.onclick=()=>downloadSvgDirect(svg2,'grafico-2.svg');
        ctrl2.append(bC2, bD2);
    }

    // Modal Edit
    function openEditModal() { const m=document.getElementById('editModal'); const b=document.getElementById('modal-body-inputs'); b.innerHTML=''; currentTop5Data.forEach((item,i)=>{ b.innerHTML+=`<div class="modal-row"><label>Argomento ${i+1}</label><textarea id="edit-input-${i}" rows="1">${item.arg}</textarea></div>`; }); m.classList.add('open'); }
    function closeEditModal() { document.getElementById('editModal').classList.remove('open'); }
    function saveModalChanges() { currentTop5Data.forEach((item,i)=>{ item.arg = document.getElementById(`edit-input-${i}`).value; }); const colIst = findCol('istituzionale', filteredData[0])||'Istituzionale'; const institData = filteredData.filter(r => String(r[colIst]).trim() === '1'); const kpi = { 'Numero post': institData.length, 'Visualizzazioni': institData.reduce((s,r)=>s+(Number(r[cols.vis])||0),0), 'Interazioni': institData.reduce((s,r)=>s+(Number(r[cols.inter])||0),0), 'Like': institData.reduce((s,r)=>s+(Number(r[cols.like])||0),0) }; renderChartsOnly(kpi, currentTop5Data); closeEditModal(); showToast("Grafici aggiornati!", "success"); }

    // SVG Generators
    function renderInstSvgTop(headers, values) {
        const svgns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgns, 'svg');
        svg.setAttribute('viewBox', '0 0 2156 102'); svg.style.fontFamily = "'Avenir Next LT Pro', sans-serif"; svg.style.backgroundColor='white';
        const w=2156, colW=w/headers.length;
        const line = document.createElementNS(svgns, 'line'); line.setAttribute('x1',0); line.setAttribute('y1',45); line.setAttribute('x2',w); line.setAttribute('y2',45); line.setAttribute('stroke','#1b47b4'); line.setAttribute('stroke-width',2); svg.appendChild(line);
        headers.forEach((h,i)=>{
            const x=colW*i+colW/2;
            const t1 = document.createElementNS(svgns,'text'); t1.setAttribute('x',x); t1.setAttribute('y',35); t1.setAttribute('text-anchor','middle'); t1.setAttribute('font-size',34); t1.setAttribute('fill','#1b47b4'); t1.textContent=h; svg.appendChild(t1);
            const t2 = document.createElementNS(svgns,'text'); t2.setAttribute('x',x); t2.setAttribute('y',80); t2.setAttribute('text-anchor','middle'); t2.setAttribute('font-size',34); t2.setAttribute('fill','black'); t2.textContent=formatNumberInstChart(values[i]); svg.appendChild(t2);
        });
        return svg;
    }
    
    // MODIFICATA LOGICA PER TRATTARE ULTIMA COLONNA COME NUMERO (Condivisioni) E NON COME LINK VUOTO
    function renderInstSvgBottom(headers, rows) {
        const svgns = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgns, 'svg');
        const w=2156, h=135*6; svg.setAttribute('viewBox', `0 0 ${w} ${h}`); svg.style.fontFamily = "'Avenir Next LT Pro', sans-serif"; svg.style.backgroundColor='white';
        const lm=50, rm=50, imgW=350, dataW=w-lm-rm-imgW;
        const colWs = [dataW*0.45, dataW*0.1375, dataW*0.1375, dataW*0.1375, dataW*0.1375];
        let cx=lm+imgW;
        headers.forEach((h,i)=>{
            const t=document.createElementNS(svgns,'text'); t.setAttribute('x',cx+colWs[i]/2); t.setAttribute('y',125); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',34); t.setAttribute('fill','#1b47b4'); t.textContent=h; svg.appendChild(t); cx+=colWs[i];
        });
        const l=document.createElementNS(svgns,'line'); l.setAttribute('x1',lm); l.setAttribute('y1',135); l.setAttribute('x2',w-rm); l.setAttribute('y2',135); l.setAttribute('stroke','#1b47b4'); l.setAttribute('stroke-width',2); svg.appendChild(l);
        rows.slice(0,5).forEach((row,ri)=>{
            const y=135*(ri+2)-67; cx=lm+imgW;
            row.forEach((cell,ci)=>{
                const t=document.createElementNS(svgns,'text'); t.setAttribute('x',cx+colWs[ci]/2); t.setAttribute('y',y+10); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',34); t.setAttribute('fill','black');
                if(ci===0) { 
                    // NUOVA LOGICA: Supporto 'Enter' (\n) + Wrapping automatico
                    const rawLines = String(cell).split('\n'); // 1. Split su Enter
                    let lines = [];
                    const max = 35; // 2. Max chars per riga
                    
                    rawLines.forEach(rawLine => {
                         const words = rawLine.split(' ');
                         let currentLine = '';
                         words.forEach(wd => {
                             if((currentLine + wd).length > max) {
                                 lines.push(currentLine);
                                 currentLine = wd + ' ';
                             } else {
                                 currentLine += wd + ' ';
                             }
                         });
                         lines.push(currentLine);
                    });

                    t.textContent=''; 
                    lines.forEach((ln,li)=>{ 
                        const ts=document.createElementNS(svgns,'tspan'); 
                        ts.textContent=ln; 
                        ts.setAttribute('x',cx+colWs[ci]/2); 
                        // Mantengo logica centraggio verticale originale
                        ts.setAttribute('dy',li===0?(-(lines.length-1)*20):40); 
                        t.appendChild(ts); 
                    });
                } else { 
                    // Ora anche l'ultima colonna (Condivisioni) è un numero
                    t.textContent=formatNumberInstChart(cell); 
                }
                svg.appendChild(t); cx+=colWs[ci];
            });
            const l2=document.createElementNS(svgns,'line'); l2.setAttribute('x1',lm); l2.setAttribute('y1',135*(ri+2)); l2.setAttribute('x2',w-rm); l2.setAttribute('y2',135*(ri+2)); l2.setAttribute('stroke','#ccc'); svg.appendChild(l2);
        });
        return svg;
    }

    // --- 3. LABELS (MODIFICATA CON CONTROLLI MANUALE FONT E WRAPPING GEOMETRICO) ---
    function renderLabels(data) {
        const container = document.getElementById('tab-labels'); 
        container.innerHTML = '';

        // 1. Aggregazione Dati e Totali
        const aggV = {}, aggI = {};
        let totalVis = 0;
        let totalInter = 0;

        data.forEach(r => { 
            const l = r[cols.label] || 'Nessuna'; 
            const v = Number(r[cols.vis] || 0);
            const i = Number(r[cols.inter] || 0);
            
            aggV[l] = (aggV[l] || 0) + v; 
            aggI[l] = (aggI[l] || 0) + i;
            
            totalVis += v;
            totalInter += i;
        });

        const sortedV = Object.entries(aggV).map(([k, v]) => ({ label: k, val: v })).sort((a, b) => b.val - a.val);
        const sortedI = Object.entries(aggI).map(([k, v]) => ({ label: k, val: v })).sort((a, b) => b.val - a.val);

        // --- CREAZIONE STRUTTURA A DUE COLONNE ---
        const mainRow = document.createElement('div');
        mainRow.className = 'tables-row'; // Flex container

        // --- COLONNA SINISTRA (VISUALIZZAZIONI) ---
        const colVis = document.createElement('div');
        colVis.className = 'analysis-column';
        
        // 1. Tabella Visualizzazioni
        const tableVWrapper = createTableCol('Visualizzazioni', sortedV, '<i class="far fa-eye"></i>', totalVis);
        colVis.appendChild(tableVWrapper);

        // 2. Grafico Visualizzazioni (CON 2 SLIDER + DECIMAL SELECT)
        const chartVWrapper = document.createElement('div'); 
        chartVWrapper.className = 'label-chart-wrapper';
        chartVWrapper.innerHTML = `
            <div class="label-chart-header">
                <span class="label-chart-title">Top Label per Visualizzazioni</span>
                <div class="card-actions" id="actions-chart-v"></div>
            </div>
            <div class="chart-controls-row">
                <div class="control-group">
                    <label><span><i class="fas fa-text-height"></i> Label</span> <span class="slider-val" id="val-v-label">1.0</span></label>
                    <input type="range" class="range-slider" id="slider-v-label" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
                <div class="control-group">
                    <label><span><i class="fas fa-hashtag"></i> Valori</span> <span class="slider-val" id="val-v-value">1.0</span></label>
                    <input type="range" class="range-slider" id="slider-v-value" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
                <div class="control-group">
                    <label><span><i class="fas fa-sort-numeric-down"></i> Decimali</span></label>
                    <select id="sel-v-decimals" style="width:200px; padding:5px; border-radius:4px; border:1px solid #ccc;">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                    </select>
                </div>
            </div>
            <div id="svg-container-v"></div>`;
        colVis.appendChild(chartVWrapper);

        // --- COLONNA DESTRA (INTERAZIONI) ---
        const colInt = document.createElement('div');
        colInt.className = 'analysis-column';

        // 1. Tabella Interazioni
        const tableIWrapper = createTableCol('Interazioni', sortedI, '<i class="far fa-thumbs-up"></i>', totalInter);
        colInt.appendChild(tableIWrapper);

        // 2. Grafico Interazioni (CON 2 SLIDER + DECIMAL SELECT)
        const chartIWrapper = document.createElement('div'); 
        chartIWrapper.className = 'label-chart-wrapper';
        chartIWrapper.innerHTML = `
            <div class="label-chart-header">
                <span class="label-chart-title">Top Label per Interazioni</span>
                <div class="card-actions" id="actions-chart-i"></div>
            </div>
            <div class="chart-controls-row">
                <div class="control-group">
                    <label><span><i class="fas fa-text-height"></i> Label</span> <span class="slider-val" id="val-i-label">1.0</span></label>
                    <input type="range" class="range-slider" id="slider-i-label" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
                <div class="control-group">
                    <label><span><i class="fas fa-hashtag"></i> Valori</span> <span class="slider-val" id="val-i-value">1.0</span></label>
                    <input type="range" class="range-slider" id="slider-i-value" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
                <div class="control-group">
                    <label><span><i class="fas fa-sort-numeric-down"></i> Decimali</span></label>
                    <select id="sel-i-decimals" style="width:200px; padding:5px; border-radius:4px; border:1px solid #ccc;">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                    </select>
                </div>
            </div>
            <div id="svg-container-i"></div>`;
        colInt.appendChild(chartIWrapper);

        // --- APPEND DELLE COLONNE AL CONTAINER ---
        mainRow.appendChild(colVis);
        mainRow.appendChild(colInt);
        container.appendChild(mainRow);

        // --- FUNZIONE DI AGGIORNAMENTO GRAFICI ---
        const updateChart = (type) => {
            const isV = type === 'v';
            
            // Get Scales from DOM
            const scaleLabel = parseFloat(document.getElementById(`slider-${type}-label`).value);
            const scaleValue = parseFloat(document.getElementById(`slider-${type}-value`).value);
            
            // Get Decimals
            const decimals = parseInt(document.getElementById(`sel-${type}-decimals`).value);

            // Update Text indicators
            document.getElementById(`val-${type}-label`).innerText = scaleLabel.toFixed(2);
            document.getElementById(`val-${type}-value`).innerText = scaleValue.toFixed(2);

            const dataSet = isV ? sortedV.slice(0, 10) : sortedI.slice(0, 10);
            const containerId = isV ? 'svg-container-v' : 'svg-container-i';
            const actionId = isV ? 'actions-chart-v' : 'actions-chart-i';
            const metric = isV ? 'Visualizzazioni' : 'Interazioni';
            const filename = `Grafico_Label_${metric}.svg`;

            // Clear previous
            const containerDiv = document.getElementById(containerId);
            containerDiv.innerHTML = '';
            
            // Render new (pass decimals)
            const svg = renderLabelSvg(dataSet, metric, scaleLabel, scaleValue, decimals);
            containerDiv.appendChild(svg);

            // Re-bind export buttons to current SVG
            const actionDiv = document.getElementById(actionId);
            actionDiv.innerHTML = '';
            const btnCopy = document.createElement('button'); btnCopy.className = 'action-btn'; 
            btnCopy.innerHTML = '<i class="far fa-copy"></i> Copia HQ';
            btnCopy.onclick = () => copySvgHighRes(containerDiv.querySelector('svg')); 
            
            const btnDown = document.createElement('button'); btnDown.className = 'action-btn yellow'; 
            btnDown.innerHTML = '<i class="fas fa-download"></i> SVG Trasparente';
            btnDown.onclick = () => downloadTransparentSvg(containerDiv.querySelector('svg'), filename);

            actionDiv.append(btnCopy, btnDown);
        };

        // Inizializza i grafici (scale 1.0)
        updateChart('v');
        updateChart('i');

        // Listener Slider & Select
        ['v', 'i'].forEach(t => {
            document.getElementById(`slider-${t}-label`).addEventListener('input', () => updateChart(t));
            document.getElementById(`slider-${t}-value`).addEventListener('input', () => updateChart(t));
            document.getElementById(`sel-${t}-decimals`).addEventListener('change', () => updateChart(t));
        });
    }

    // Helper per creare colonna tabella (Restituisce elemento DIV anziché appenderlo)
    function createTableCol(title, dataList, icon, totalVal) {
        const card = document.createElement('div');
        card.className = 'table-col';
        
        const header = document.createElement('div');
        header.className = 'table-header-actions';
        header.innerHTML = `<h3>${icon} ${title}</h3>`;
        
        const tbl = document.createElement('table');
        header.appendChild(createTableCopyBtn(tbl));
        
        card.appendChild(header);

        tbl.innerHTML = `<thead><tr><th>Label</th><th>Valore</th></tr></thead><tbody></tbody>`;
        
        // Corpo Tabella
        dataList.forEach(item => {
            tbl.querySelector('tbody').innerHTML += `<tr><td>${item.label}</td><td>${formatNumberItalian(item.val)}</td></tr>`;
        });

        // Piede Tabella
        const tfoot = document.createElement('tfoot');
        const formattedTotal = formatSmartKM(totalVal);
        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `<td>TOTALE</td><td><div style="display:flex; justify-content:space-between; align-items:center;"><span>${formattedTotal}</span></div></td>`;
        trTotal.querySelector('div').appendChild(createCopyBtn(formattedTotal));
        
        tfoot.appendChild(trTotal);
        tbl.appendChild(tfoot);
        
        const tw = document.createElement('div');
        tw.className = 'table-wrapper';
        tw.style.maxHeight = '400px'; 
        tw.appendChild(tbl);
        card.appendChild(tw);
        return card;
    }

    // --- 4. TOPICS ---
    function renderTopics(data) {
        const container = document.getElementById('tab-topics'); container.innerHTML = '';
        const topics={};
        data.forEach(r=>{ const a=r[cols.arg]||'Altro'; if(!topics[a]) topics[a]={n:0, v:0}; topics[a].n++; topics[a].v+=Number(r[cols.vis]||0); });
        const top = Object.entries(topics).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,10);
        
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = '<h2><i class="fas fa-list-ol"></i> Top 10 Argomenti</h2><div class="table-wrapper"><table><thead><tr><th>Argomento</th><th>Post</th><th>Visualizzazioni</th></tr></thead><tbody></tbody></table></div>';
        top.forEach(t=>{ card.querySelector('tbody').innerHTML+=`<tr><td>${t.arg}</td><td>${t.n}</td><td>${formatNumber(t.v)}</td></tr>`; });
        container.appendChild(card);
    }

    // --- 5. CHANNELS (FULL - MODIFICATO PER TOGGLE ASSE SPEZZATO CON CONTROLLO MANUALE) ---
    function renderChannels(data) {
        const container = document.getElementById('tab-channels'); container.innerHTML = '';
        const counts = {}; data.forEach(r => { const c = String(r[cols.canale]).toLowerCase(); counts[c] = (counts[c]||0) + 1; });
        const sortedChans = Object.entries(counts).sort((a,b) => b[1]-a[1]);

        const card = document.createElement('div'); card.className='card';
        card.innerHTML = '<h2><i class="fas fa-filter"></i> Dettaglio Canale</h2>';
        const sel = document.createElement('select'); sel.id='chan-sel';
        sel.innerHTML = '<option value="">-- Seleziona un Canale --</option>';
        sortedChans.forEach(([k,v]) => { sel.innerHTML += `<option value="${k}">${k.toUpperCase()} (${v})</option>`; });
        card.appendChild(sel);
        const contentArea = document.createElement('div'); contentArea.id = 'chan-content-area'; card.appendChild(contentArea);
        container.appendChild(card);

        // VARIABILI DI STATO LOCALE PER IL TOGGLE E I LIMITI
        let isCappedMode = false;
        let capLimitVis = 0;
        let capLimitInt = 0;

        sel.addEventListener('change', (e) => {
            const val = e.target.value; contentArea.innerHTML = ''; if(!val) return;
            const chanData = data.filter(r => String(r[cols.canale]).toLowerCase() === val);
            const sortedForChart = [...chanData].sort((a,b)=>{ const pa=formatDate(a[cols.data]).split('/'), pb=formatDate(b[cols.data]).split('/'); return new Date(2000+parseInt(pa[2]),pa[1]-1,pa[0]) - new Date(2000+parseInt(pb[2]),pb[1]-1,pb[0]); });

            // Accordion 1: D3 Charts (RIPRISTINATI ORIGINALI CON LOGICA D3 + TOGGLE + INPUTS)
            const acc1 = document.createElement('details'); acc1.className='accordion-item'; acc1.open = true;
            acc1.innerHTML = `<summary><i class="fas fa-chart-bar"></i> Analisi Temporale</summary>`;
            const acc1Body = document.createElement('div'); acc1Body.className='accordion-content';
            
            // --- NUOVO CONTROLLO: TOGGLE ASSE SPEZZATO + INPUTS (LAYOUT MIGLIORATO) ---
            const toggleDiv = document.createElement('div');
            toggleDiv.style.marginBottom = '20px';
            toggleDiv.style.display = 'flex';
            toggleDiv.style.flexDirection = 'column';
            toggleDiv.style.gap = '15px';
            toggleDiv.innerHTML = `
                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                    <label style="cursor:pointer; font-weight:600; color:var(--primary); display:flex; align-items:center; gap:8px; font-size:0.95rem;">
                        <input type="checkbox" id="cap-axis-toggle" style="transform:scale(1.2);">
                        Taglia Picchi (Controllo Manuale)
                    </label>
                    
                    <div id="manual-caps-container" style="display:none; align-items:center; gap:15px; background:#f9f9f9; padding:5px 10px; border-radius:6px; border:1px solid #eee;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <label for="cap-input-vis" style="font-size:0.85rem; color:#555; font-weight:600;">Limite Vis:</label>
                            <input type="number" id="cap-input-vis" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <label for="cap-input-int" style="font-size:0.85rem; color:#555; font-weight:600;">Limite Int:</label>
                            <input type="number" id="cap-input-int" style="width:100px; padding:4px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight:600; color:var(--text-light); font-size:0.85rem;">RAGGRUPPA PER:</span>
                    <button class="action-btn active" id="gran-day" onclick="updateGranularity('day')">Giorno</button>
                    <button class="action-btn" id="gran-week" onclick="updateGranularity('week')">Settimana</button>
                    <button class="action-btn" id="gran-month" onclick="updateGranularity('month')">Mese</button>
                </div>
            `;
            acc1Body.appendChild(toggleDiv);

            // Variabile di stato locale per la granularità
            window.currentGranularity = 'day';
            window.updateGranularity = (mode) => {
                window.currentGranularity = mode;
                document.querySelectorAll('[id^="gran-"]').forEach(b => b.classList.remove('active'));
                document.getElementById('gran-' + mode).classList.add('active');
                renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt);
            };

            const chartsDiv = document.createElement('div');
            chartsDiv.innerHTML = `<div class="charts-container"><div class="chart-wrapper" id="visChartContainer"></div><div class="chart-wrapper" id="interChartContainer"></div></div>`;
            acc1Body.appendChild(chartsDiv);

            const subAcc = document.createElement('details'); subAcc.className = 'nested-accordion';
            subAcc.innerHTML = '<summary>Tabelle Dati Giornalieri</summary>';
            const subContent = document.createElement('div'); subContent.className = 'nested-content panels-row';
            subContent.innerHTML = '<div class="panel-col"><div class="table-wrapper"><table id="tableVisChan"><thead><tr><th>Data</th><th>Vis</th></tr></thead><tbody></tbody></table></div></div><div class="panel-col"><div class="table-wrapper"><table id="tableInterChan"><thead><tr><th>Data</th><th>Int</th></tr></thead><tbody></tbody></table></div></div>';
            subAcc.appendChild(subContent); acc1Body.appendChild(subAcc); acc1.appendChild(acc1Body); contentArea.appendChild(acc1);
            
            // FUNZIONE DI CALCOLO SUGGERIMENTI (2° Max + 20%)
            const calculateSuggestion = (metricKey) => {
                // Raggruppa per data
                const groups = {};
                sortedForChart.forEach(d => {
                    const fd = formatDate(d[cols.data]);
                    if(!groups[fd]) groups[fd] = 0;
                    groups[fd] += Number(d[metricKey] || 0);
                });
                const values = Object.values(groups).sort((a,b) => b - a);
                // Se c'è almeno un valore, prendi il 2° (o il 1° se ce n'è solo uno)
                let base = values.length > 1 ? values[1] : values[0];
                // Se il primo è molto più grande, suggeriamo il secondo. Altrimenti il primo.
                if (values.length > 1 && values[0] > values[1] * 1.5) {
                    base = values[1] * 1.2;
                } else {
                    base = values[0]; // Non c'è bisogno di tagliare
                }
                return Math.round(base);
            };

            // LOGICA EVENTI
            const toggleEl = document.getElementById('cap-axis-toggle');
            const inputsContainer = document.getElementById('manual-caps-container');
            const inputVis = document.getElementById('cap-input-vis');
            const inputInt = document.getElementById('cap-input-int');

            toggleEl.addEventListener('change', (evt) => {
                isCappedMode = evt.target.checked;
                if (isCappedMode) {
                    // Calcola suggerimenti e riempi input
                    capLimitVis = calculateSuggestion(cols.vis);
                    capLimitInt = calculateSuggestion(cols.inter);
                    inputVis.value = capLimitVis;
                    inputInt.value = capLimitInt;
                    inputsContainer.style.display = 'flex';
                } else {
                    inputsContainer.style.display = 'none';
                }
                renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt);
            });

            // Eventi Input Manuale
            inputVis.addEventListener('input', (e) => {
                capLimitVis = Number(e.target.value) || 0;
                renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt);
            });
            inputInt.addEventListener('input', (e) => {
                capLimitInt = Number(e.target.value) || 0;
                renderApp2ChartsAndTables(sortedForChart, isCappedMode, capLimitVis, capLimitInt);
            });

            // PRIMO RENDER (DEFAULT FALSE)
            setTimeout(() => { 
                toggleEl.checked = false;
                renderApp2ChartsAndTables(sortedForChart, false, 0, 0); 
            }, 50); 

            // Accordion 2: Feed Posts
            const acc2 = document.createElement('details'); acc2.className='accordion-item';
            acc2.innerHTML = `<summary><i class="fas fa-stream"></i> Feed dei Post</summary>`;
            const acc2Body = document.createElement('div'); acc2Body.className='accordion-content';
            renderChannelCards(chanData, acc2Body, val);
            acc2.appendChild(acc2Body); contentArea.appendChild(acc2);
        });
    }
    
    // FUNZIONE DI RENDERING D3 COMPLETA (AGGIORNATA PER GRANULARITÀ E RANGE DINAMICO)
    function renderApp2ChartsAndTables(data, isCapped, limitVis, limitInt) {
        const tv = document.getElementById('tableVisChan').querySelector('tbody');
        const ti = document.getElementById('tableInterChan').querySelector('tbody');
        tv.innerHTML=''; ti.innerHTML='';
        
        if (data.length === 0) return;

        // 1. Popolamento Tabelle (sempre dettaglio giornaliero)
        data.forEach(r => {
            const d = formatDate(r[cols.data]);
            tv.innerHTML += `<tr><td>${d}</td><td>${formatNumberItalian(r[cols.vis])}</td></tr>`;
            ti.innerHTML += `<tr><td>${d}</td><td>${formatNumberItalian(r[cols.inter])}</td></tr>`;
        });

        const visTot = data.reduce((a,c)=>a+Number(c[cols.vis]||0),0);
        const intTot = data.reduce((a,c)=>a+Number(c[cols.inter]||0),0);

        // 2. Logica di Aggregazione per i Grafici
        const mode = window.currentGranularity || 'day';
        const grouped = {};

        data.forEach(r => {
            const dStr = formatDateForCompare(r[cols.data]);
            const dObj = new Date(dStr);
            let key, label;

            if (mode === 'month') {
                key = `${dObj.getFullYear()}-${String(dObj.getMonth() + 1).padStart(2, '0')}-01`;
                const mesi = ["Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"];
                label = `${mesi[dObj.getMonth()]} ${dObj.getFullYear().toString().slice(-2)}`;
            } else if (mode === 'week') {
                // Calcola il lunedì della settimana corrente
                const day = dObj.getDay(), diff = dObj.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(dObj.setDate(diff));
                key = monday.toISOString().split('T')[0];
                label = `Sett ${monday.getDate()}/${monday.getMonth()+1}`;
            } else {
                key = dStr;
                label = formatDate(dStr).split('/').slice(0,2).join('/');
            }

            if (!grouped[key]) grouped[key] = { label: label, vis: 0, inter: 0 };
            grouped[key].vis += Number(r[cols.vis] || 0);
            grouped[key].inter += Number(r[cols.inter] || 0);
        });

        const sortedKeys = Object.keys(grouped).sort();
        const aggregatedData = sortedKeys.map(k => ({ date: grouped[k].label, vis: grouped[k].vis, inter: grouped[k].inter }));
        
        // 3. Disegno Grafici con dati aggregati
        drawChart('visChartContainer', aggregatedData, 'vis', 'VISUALIZZAZIONI', visTot, isCapped, limitVis);
        drawChart('interChartContainer', aggregatedData, 'inter', 'INTERAZIONI', intTot, isCapped, limitInt);
    }
    
    function getAllDaysInMonth(year, month) {
        const date = new Date(year, month, 1);
        const dates = [];
        while (date.getMonth() === month) {
            const d = ('0' + date.getDate()).slice(-2);
            const m = ('0' + (date.getMonth() + 1)).slice(-2);
            dates.push(`${d}/${m}/${year}`);
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }

    function drawChart(containerId, aggregatedData, metric, title, total, isCapped, capLimit) {
        const container = d3.select("#" + containerId);
        container.html("");
        const buttons = container.append('div').attr('class', 'chart-buttons');
        const copyBtn = buttons.append('button').attr('class', 'chart-btn').html('<i class="material-icons" style="font-size: 20px;">content_copy</i>');
        const downloadBtn = buttons.append('button').attr('class', 'chart-btn').html('<i class="material-icons" style="font-size: 20px;">download</i>');

        const margin = {top: 75, right: 20, bottom: 50, left: 55};
        const svgWidth = 1200;
        const svgHeight = 453;
        const width = svgWidth - margin.left - margin.right;
        const height = svgHeight - margin.top - margin.bottom;
        
        const svg = container.append("svg").attr("viewBox", `0 0 ${svgWidth} ${svgHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        const x = d3.scaleBand().domain(aggregatedData.map(d => d.date)).range([0, width]).padding(0.3);
        
        let yDomainMax = d3.max(aggregatedData, d => d[metric]) || 1;
        if (isCapped && capLimit > 0) yDomainMax = capLimit;

        const y = d3.scaleLinear().domain([0, yDomainMax]).range([height, isCapped ? 50 : 0]);

        const xAxis = d3.axisBottom(x).tickSize(0);
        if (aggregatedData.length > 20) {
            xAxis.tickValues(x.domain().filter((d,i) => i % Math.ceil(aggregatedData.length/15) === 0));
        }

        svg.append("g").attr("class", "x-axis").attr("transform", `translate(0,${height})`).call(xAxis).call(g => g.select(".domain").remove());
        const yAxisG = svg.append("g").attr("class", "y-axis").call(d3.axisLeft(y).ticks(5).tickFormat(d => formatKValue(d)));
        yAxisG.call(g => g.select(".domain").remove());
        yAxisG.selectAll(".tick line").clone().attr("x2", width).attr("stroke", "#e0e0e0").attr("stroke-opacity", 0.7);

        const header = svg.append("g").attr("class", "chart-header").attr("transform", `translate(${-40}, 0)`);
        header.append("text").attr("y", -30).html(`<tspan style="font-size:32px; font-weight:800; fill:#0431AE;">${title}</tspan><tspan style="font-size:32px; font-weight:300; fill:#3a3a3a;" dx="20">Totale: ${formatKValue(total)}</tspan>`);
        header.append("line").attr("x1", 0).attr("x2", width / 2).attr("y1", -15).attr("y2", -15).attr("stroke", "#0431AE");

        svg.selectAll(".bar-group").data(aggregatedData).enter().append("g").each(function(d) {
            const val = d[metric];
            const isClipped = isCapped && val > yDomainMax;
            const barHeight = height - y(isClipped ? yDomainMax : val);
            const barY = y(isClipped ? yDomainMax : val);
            const bw = x.bandwidth();
            const g = d3.select(this);
            
            if (isClipped) {
                 const xPos = x(d.date);
                 g.append("path").attr("d", `M ${xPos} ${barY + barHeight} L ${xPos} ${barY + bw} L ${xPos + bw} ${barY} L ${xPos + bw} ${barY + barHeight} Z`).style("fill", "#bfd7fd");
                 g.append("text").attr("x", xPos + bw / 2).attr("y", barY - 5).attr("text-anchor", "middle").style("font-size", "14px").style("font-weight", "bold").style("fill", "#0431AE").text(formatKValue(val));
             } else {
                 g.append("rect").attr("x", x(d.date)).attr("y", barY).attr("width", bw).attr("height", barHeight).style("fill", "#bfd7fd");
             }
        });

        downloadBtn.on('click', () => downloadSvgDirect(container.select('svg').node(), `grafico-${title}.svg`));
        copyBtn.on('click', () => copySvgHighRes(container.select('svg').node()));
    }

    function renderChannelCards(posts, container, channelName) {
        container.innerHTML = '';
        const ctrlDiv = document.createElement('div'); ctrlDiv.className = 'feed-controls';
        
        const btnView = document.createElement('button'); btnView.className = 'action-btn active'; btnView.innerHTML = '<i class="far fa-eye"></i> Ordina per Visualizzazioni';
        const btnInt = document.createElement('button'); btnInt.className = 'action-btn'; btnInt.innerHTML = '<i class="far fa-thumbs-up"></i> Ordina per Interazioni';
        
        const btnExp = document.createElement('button'); btnExp.className = 'action-btn excel'; btnExp.innerHTML = '<i class="fas fa-file-excel"></i> Scarica Excel';
        btnExp.onclick = () => { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(posts), "Posts"); XLSX.writeFile(wb, "Feed.xlsx"); };

        ctrlDiv.append(btnView, btnInt, btnExp); container.appendChild(ctrlDiv);
        const gridDiv = document.createElement('div'); gridDiv.className = 'post-grid'; container.appendChild(gridDiv);

        window.currentChannelPosts = posts;

        const render = (sortType) => {
            gridDiv.innerHTML = '';
            let sorted = [...posts];
            if (sortType === 'views') sorted.sort((a,b) => (Number(b[cols.vis])||0) - (Number(a[cols.vis])||0));
            else sorted.sort((a,b) => (Number(b[cols.inter])||0) - (Number(a[cols.inter])||0));
            
            window.currentChannelPosts = sorted;

            sorted.slice(0, 50).forEach((r, idx) => {
                const label = (r[cols.label] || 'Account').toUpperCase();
                const arg = r[cols.arg] || 'Generale';
                const date = formatDate(r[cols.data]);
                const copyText = r[cols.copy] || '';
                const visF = formatNumber(r[cols.vis]);
                const intF = formatNumber(r[cols.inter]);
                const postLink = r[cols.link]; // Recupero Link
                
                // MODIFICA: Aggiunto pulsante copia accanto all'Argomento e Pulsante Link nel Footer
                const card = document.createElement('div'); card.className = 'post-card';
                card.innerHTML = `
                    <div class="post-header"><div class="post-channel-icon">${getChannelIcon(channelName)}</div><div class="post-meta"><div class="post-label">${label}</div><div class="post-date">${date}</div></div></div>
                    <div class="post-body">
                        <span class="post-topic">
                            ${arg} 
                            <button class="copy-btn" style="color:var(--primary); margin-left:6px; font-size:1em;" onclick="event.stopPropagation(); navigator.clipboard.writeText('${arg.replace(/'/g, "\\'")}').then(()=>showToast('Argomento Copiato!','success'))" title="Copia argomento">
                                <i class="far fa-copy"></i>
                            </button>
                        </span>
                        <div class="post-text">${copyText}</div>
                    </div>
                    <div class="post-footer">
                        <div class="post-metrics"><div class="metric-item views"><i class="far fa-eye"></i> ${visF}</div><div class="metric-item likes"><i class="far fa-thumbs-up"></i> ${intF}</div></div>
                        <div class="post-actions-right">
                             ${postLink ? `<a href="${postLink}" target="_blank" class="post-link-btn" style="text-decoration:none; margin-right:8px;" title="Vai al post"><i class="fas fa-external-link-alt"></i></a>` : ''}
                             <button class="action-btn blue-fill" onclick="openPostGraphModal(${idx})"><i class="fas fa-image"></i> Crea Grafica</button>
                        </div>
                    </div>`;
                gridDiv.appendChild(card);
            });
        };

        btnView.onclick = () => { btnView.classList.add('active'); btnInt.classList.remove('active'); render('views'); };
        btnInt.onclick = () => { btnInt.classList.add('active'); btnView.classList.remove('active'); render('inter'); };
        render('views');
    }

    // --- NUOVA LOGICA: GENERATORE GRAFICA POST ---
    function openPostGraphModal(index) {
        const post = window.currentChannelPosts[index]; if(!post) return;
        currentPostData = { label: (post[cols.label] || 'Account').toUpperCase(), data: formatDate(post[cols.data]), argomento: post[cols.arg] || 'Argomento', copy: post[cols.copy] || '', views: Number(post[cols.vis] || 0), inter: Number(post[cols.inter] || 0) };
        document.getElementById('pg-argomento').value = currentPostData.argomento;
        document.getElementById('pg-copy').value = currentPostData.copy;
        document.getElementById('pg-views').value = formatNumberFull(currentPostData.views);
        document.getElementById('pg-inter').value = formatNumberFull(currentPostData.inter);
        document.getElementById('pg-info').value = `${currentPostData.label} - ${currentPostData.data}`;
        updatePostSvg();
        document.getElementById('postGraphModal').classList.add('open');
    }

    function closePostGraphModal() { document.getElementById('postGraphModal').classList.remove('open'); }

    function updatePostSvg() {
        const arg = document.getElementById('pg-argomento').value;
        const cpy = document.getElementById('pg-copy').value;
        const svgString = generatePostSvgString({ ...currentPostData, argomento: arg, copy: cpy });
        document.getElementById('pg-preview-container').innerHTML = svgString;
    }

    function generatePostSvgString(d) {
        const visualizzazioni = formatNumberFull(d.views);
        const interazioni = formatNumberFull(d.inter);
        const words = d.copy.split(' '); const lines = []; let currentLine = ''; const maxCharsPerLine = 62; const maxLines = 3;
        for (let i = 0; i < words.length; i++) {
            const word = words[i]; const testLine = currentLine ? currentLine + ' ' + word : word;
            if (testLine.length <= maxCharsPerLine) { currentLine = testLine; } else { lines.push(currentLine); currentLine = word; }
            if (lines.length === maxLines - 1 && i < words.length - 1) {
                let remainingWords = words.slice(i + 1).join(' '); let lastLineWithEllipsis = currentLine; const ellipsis = ' (...)';
                while ((lastLineWithEllipsis + ' ' + remainingWords).length > maxCharsPerLine && remainingWords.includes(' ')) { const lastSpaceIndex = remainingWords.lastIndexOf(' '); if (lastSpaceIndex === -1) break; remainingWords = remainingWords.substring(0, lastSpaceIndex); }
                lastLineWithEllipsis = (lastLineWithEllipsis ? lastLineWithEllipsis + ' ' : '') + remainingWords;
                while (lastLineWithEllipsis.length + ellipsis.length > maxCharsPerLine && lastLineWithEllipsis.includes(' ')) { const lastSpaceIndex = lastLineWithEllipsis.lastIndexOf(' '); lastLineWithEllipsis = lastLineWithEllipsis.substring(0, lastSpaceIndex); }
                lines.push(lastLineWithEllipsis + ellipsis); currentLine = ''; break;
            }
        }
        if (currentLine && lines.length < maxLines) lines.push(currentLine);
        const copyTSpan = lines.map((line, index) => `<tspan x="30" dy="${index === 0 ? 0 : 30}">${line}</tspan>`).join('');
        return `<svg width="868" height="441" viewBox="0 0 868 441" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="868" height="77" fill="#E1E9F6"/><text x="434" y="55" font-family="Arial, sans-serif" font-size="40" fill="#0A4BB8" text-anchor="middle" alignment-baseline="middle">${d.label}</text><text x="30" y="125" font-family="Arial, sans-serif" font-size="30" font-weight="bold" fill="#0A4BB8">${d.argomento}</text><text x="130" y="226" font-family="Arial, sans-serif" font-size="30" fill="#666666">Pubblicato il ${d.data}</text><text x="30" y="290" font-family="Arial, sans-serif" font-size="30" fill="#666666">${copyTSpan}</text><text x="30" y="415" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Visualizzazioni:</text><text x="270" y="415" font-family="Arial, sans-serif" font-size="32" fill="#666666">${visualizzazioni}</text><text x="410" y="415" font-family="Arial, sans-serif" font-size="32" fill="#0A4BB8" font-weight="bold">Interazioni:</text><text x="590" y="415" font-family="Arial, sans-serif" font-size="32" fill="#666666">${interazioni}</text></svg>`;
    }

    function downloadPostSvg() {
        const svgEl = document.querySelector('#pg-preview-container svg'); if(!svgEl) return;
        const filename = `Grafica_${currentPostData.label}_${currentPostData.argomento.substring(0,10)}.svg`;
        downloadSvgDirect(svgEl, filename); showToast("SVG Scaricato", "success");
    }

    function copyPostSvg() {
        const svgEl = document.querySelector('#pg-preview-container svg'); if(!svgEl) return;
        // MODIFICATO PER USARE copySvgHighRes invece di png normale
        copySvgHighRes(svgEl);
    }

    // --- GENERATORE SVG CUSTOM PER LABEL (LOGICA GEOMETRICA E CENTRATURA PERFETTA) ---
    function renderLabelSvg(data, metricName, scaleLabel, scaleValue, decimals) {
        const svgns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgns, 'svg');
        
        // 1. Risoluzione fissa 2800x2000
        const w = 2800;
        const h = 2000;
        
        // 2. Intestazione RIMOSSA
        const headerH = 20; 
        const footerH = 50;
        const availableH = h - headerH - footerH;
        
        // Calcolo altezza riga
        const rowH = availableH / (data.length || 1);
        const barHeight = rowH * 0.6; // Altezza barra

        // --- FONT DINAMICO ---
        // Base: circa metà barra (max 90px), moltiplicato per lo slider dell'utente
        const fontSizeRaw = Math.min(90, barHeight * 0.45) * scaleLabel;
        const valueFontSize = Math.min(70, barHeight * 0.55) * scaleValue;
        
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
        svg.setAttribute('xmlns', svgns);
        svg.style.fontFamily = "'Avenir Next LT Pro', 'Segoe UI', sans-serif";
        
        // Calcolo Scala e Spazi
        const maxVal = data.length > 0 ? data[0].val : 1;
        const maxBarW = w * 0.50; 
        const startBarX = w * 0.35; // La barra inizia al 35% della larghezza (pixel 980)
        
        // CALCOLO SPAZIO DISPONIBILE PER LA LABEL (Pixel)
        // 980px (inizio barra) - 20px (margine sx) - 35px (padding sicurezza leggero)
        // Aumentato lo spazio utile per evitare wrap prematuri
        const maxLabelPixelWidth = startBarX - 55; 

        data.forEach((item, i) => {
            const y = headerH + (i * rowH);
            const centerY = y + (rowH / 2); // Centro esatto della riga
            const barW = (item.val / maxVal) * maxBarW;
            
            // --- LOGICA A CAPO GEOMETRICA ---
            // Stimiamo la larghezza del testo in pixel:
            // Lunghezza stringa * Dimensione Font * 0.48 (fattore medio larghezza carattere ottimizzato per Avenir)
            const estimatedTextPixelWidth = item.label.length * (fontSizeRaw * 0.48);
            
            // Se la larghezza stimata supera lo spazio disponibile, andiamo a capo
            const shouldWrap = estimatedTextPixelWidth > maxLabelPixelWidth;

            const labelText = document.createElementNS(svgns, 'text');
            labelText.setAttribute('x', 20);
            labelText.setAttribute('font-size', fontSizeRaw); 
            labelText.setAttribute('fill', '#333');

            if(shouldWrap) {
                 // --- TESTO SU DUE RIGHE ---
                 const words = item.label.split(' ');
                 let line1 = '', line2 = '';
                 
                 // Cerchiamo di spezzare a metà per bilanciare, o finché c'è spazio
                 const targetLen = item.label.length / 2; // Punto ideale di rottura
                 
                 for(let wd of words) {
                    // Se la riga 1 è ancora "vuota" o sotto la metà ideale E la riga non diventa troppo lunga
                    if ( (line1.length < targetLen || line1.length === 0) && (line1.length + wd.length) * (fontSizeRaw * 0.48) < maxLabelPixelWidth) {
                        line1 += wd + ' ';
                    } else {
                        line2 += wd + ' ';
                    }
                 }
                 
                 // Fallback se una parola è lunghissima
                 if(!line1 && words.length > 0) { line1 = words[0]; line2 = words.slice(1).join(' '); }

                 // CALCOLO POSIZIONE VERTICALE PERFETTA (CENTER STRADDLE)
                 // Y di partenza (baseline della prima riga) = Centro - Metà Altezza Blocco + CapHeight
                 // Regolazione fine per centratura ottica
                 const lineHeight = fontSizeRaw * 1.1; 
                 const startY = centerY - (fontSizeRaw * 0.2); // Punto ottimale per prima riga

                 // Riga 1
                 const ts1 = document.createElementNS(svgns, 'tspan');
                 ts1.textContent = line1.trim();
                 ts1.setAttribute('x', 20);
                 ts1.setAttribute('y', startY); 

                 // Riga 2
                 const ts2 = document.createElementNS(svgns, 'tspan');
                 ts2.textContent = line2.trim();
                 ts2.setAttribute('x', 20);
                 ts2.setAttribute('dy', lineHeight); 

                 labelText.appendChild(ts1);
                 labelText.appendChild(ts2);

            } else {
                 // --- TESTO SU RIGA SINGOLA ---
                 labelText.textContent = item.label;
                 // Centratura verticale: y + (1/3 del font size per compensare la baseline)
                 labelText.setAttribute('y', centerY + (fontSizeRaw * 0.35)); 
            }
            svg.appendChild(labelText);
            
            // 3. The Bar
            const rect = document.createElementNS(svgns, 'rect');
            rect.setAttribute('x', startBarX);
            rect.setAttribute('y', centerY - (barHeight / 2)); // Centratura esatta barra
            rect.setAttribute('width', Math.max(barW, 5)); 
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', '#eedc00'); 
            rect.setAttribute('stroke', '#0431ae'); 
            rect.setAttribute('stroke-width', 5); 
            rect.setAttribute('rx', 15);
            svg.appendChild(rect);

            // 5. Value Text
            const valText = document.createElementNS(svgns, 'text');
            valText.setAttribute('x', startBarX + Math.max(barW, 5) + 30);
            valText.setAttribute('y', centerY + (valueFontSize * 0.35)); // Centratura esatta valore
            valText.setAttribute('text-anchor', 'start'); 
            valText.setAttribute('font-size', valueFontSize);
            valText.setAttribute('fill', '#0431ae');
            valText.setAttribute('font-weight', 'bold');
            // USA LA NUOVA FUNZIONE CON I DECIMALI SELEZIONATI
            valText.textContent = formatCustomDecimals(item.val, decimals);
            svg.appendChild(valText);
            
            // Separator line
            if (i < data.length - 1) {
                const sep = document.createElementNS(svgns, 'line');
                sep.setAttribute('x1', 0); sep.setAttribute('y1', y + rowH);
                sep.setAttribute('x2', w); sep.setAttribute('y2', y + rowH);
                sep.setAttribute('stroke', '#eee');
                sep.setAttribute('stroke-width', 2);
                svg.appendChild(sep);
            }
        });

        return svg;
    }

    // Helper specifico per download trasparente
    function downloadTransparentSvg(svgElement, filename) {
        if (!svgElement) return;
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svgElement);
        
        if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }
        
        source = source.replace('>', '><style>@font-face { font-family: "Avenir Next LT Pro"; src: url("https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/fonts/AvenirNextLTPro-Regular.woff2") format("woff2"); } text { font-family: "Avenir Next LT Pro", sans-serif; }</style>');

        const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
