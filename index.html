<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Social Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #00529F;
      --primary-hover: #003e7e;
      --bg: #f4f6f8;
      --text: #2c3e50;
      --text-light: #607d8b;
      --card-bg: #fff;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
      --icon-size: 1.5rem; 
      --icon-color: #00529F;
    }
    
    body { 
      margin: 0; 
      font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      font-size: 15px; 
      line-height: 1.5; 
    }
    
    /* Header */
    header { 
      background: var(--primary); 
      color: #fff; 
      padding: 1rem 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    
    .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
    
    /* Area Upload */
    .upload-area {
      background: var(--card-bg);
      border: 3px dashed #cbd5e0;
      border-radius: var(--border-radius);
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .upload-area:hover { border-color: var(--primary); background: #f0f7ff; }
    .upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .upload-text { font-size: 1.1rem; color: var(--text-light); font-weight: 500; }
    .upload-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem; display: block; }

    /* Tabs */
    .tabs-container { display: none; }
    .tabs-header { display: flex; gap: 10px; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
    .tab-btn {
      padding: 10px 20px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.95rem;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .tab-content { display: none; animation: fadeIn 0.4s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Executive Button */
    #exec-btn { 
      background-color: #27ae60; color: white; border: none; padding: 8px 16px; 
      border-radius: 6px; font-weight: 600; cursor: pointer; display: none; font-size: 0.9rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #exec-btn:hover { background-color: #219150; }

    /* Cards Gen */
    .card { background: var(--card-bg); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid #e1e4e8; }
    .card h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.8rem; margin-bottom: 1.5rem; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
    .stat-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: var(--border-radius);
      padding: 1rem; position: relative; border-left: 4px solid #ddd;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); border-left-color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; }
    .stat-label i { font-size: 1.2rem; color: var(--icon-color); }
    .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--text); display: flex; align-items: center; justify-content: space-between; }

    /* --- STILE POST SOCIAL (CARD LAYOUT) --- */
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    
    .post-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }
    .post-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border-color: #cbd5e0;
    }

    /* Header Post: Icona, Label, Data */
    .post-header {
      padding: 12px 16px;
      background: #fdfdfd;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .post-channel-icon {
      font-size: 24px;
      color: var(--primary);
      margin-top: 2px;
    }
    .post-meta {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .post-label { font-weight: 700; color: #2d3748; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; }
    .post-date { font-size: 0.8rem; color: #718096; display: flex; align-items: center; gap: 6px; }
    
    /* Body Post: Topic, Copy */
    .post-body {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .post-topic {
      display: inline-block;
      background: #eef2f7;
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      align-self: flex-start;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
      /* Flex per allineare il tasto copia */
      display: inline-flex; align-items: center; gap: 6px;
    }
    .post-text {
      font-size: 0.95rem;
      color: #4a5568;
      white-space: pre-wrap; /* Mantiene a capo */
      background: #fff;
      line-height: 1.5;
      position: relative;
    }
    .post-text-wrapper {
        position: relative;
    }
    .post-text-copy-btn {
        position: absolute;
        top: 0; right: 0;
    }

    /* Footer Post: Metriche */
    .post-footer {
      padding: 12px 16px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .post-metrics {
      display: flex;
      gap: 15px;
    }
    .metric-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #4a5568;
    }
    .metric-item i { color: #a0aec0; }
    .metric-item.views i { color: #3498db; }
    .metric-item.likes i { color: #e74c3c; }

    /* Bottone Link Esterno */
    .post-link-btn {
      color: #718096;
      transition: color 0.2s;
      font-size: 1.1rem;
    }
    .post-link-btn:hover { color: var(--primary); }

    /* --- TASTO COPIA & UTILS --- */
    .copy-btn {
      background: transparent; 
      color: #cbd5e0; 
      border: none; 
      padding: 2px;
      font-size: 0.9rem; 
      cursor: pointer; 
      transition: all 0.2s ease-in-out;
      opacity: 0.6;
    }
    .copy-btn:hover { color: var(--primary); transform: scale(1.15); opacity: 1; }
    /* Nelle card, rendiamo i copy btn visibili al click o hover del contenitore */
    .post-card:hover .copy-btn { opacity: 1; color: #a0aec0; }
    .post-card .copy-btn:hover { color: var(--primary); }

    .save-table, .save-channel-table { background: #f1c40f; color: #333; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; display: inline-flex; gap: 6px; align-items: center; margin-bottom: 1rem; }
    .save-table:hover { background: #d4ac0d; }

    /* Tabella Classica per Overview/Istituzionale */
    .table-wrapper { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { background: #f8fafc; color: #4a5568; font-weight: 700; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
    td { padding: 12px; border-bottom: 1px solid #edf2f7; vertical-align: middle; font-size: 0.9rem; }
    tr:hover td { background-color: #f7fafc; }

    /* Toast */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 24px; color: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

  </style>
</head>
<body>

  <header>
    <h1><i class="fas fa-chart-line"></i> Dashboard Report Social</h1>
    <button id="exec-btn"><i class="fas fa-file-code"></i> JSON Executive</button>
  </header>
  
  <div id="toast-container"></div>

  <div class="container">
    <div class="upload-area" id="upload-box">
      <input type="file" id="file-input" accept=".xlsx, .xls" />
      <span class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></span>
      <div class="upload-text" id="upload-label">Trascina il file Excel qui o clicca per caricare</div>
    </div>

    <div id="main-content" class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('tab-overview')"><i class="fas fa-home"></i> Panoramica</button>
        <button class="tab-btn" onclick="switchTab('tab-instit')"><i class="fas fa-building"></i> Istituzionale</button>
        <button class="tab-btn" onclick="switchTab('tab-topics')"><i class="fas fa-tags"></i> Argomenti</button>
        <button class="tab-btn" onclick="switchTab('tab-channels')"><i class="fas fa-share-alt"></i> Canali</button>
      </div>

      <div id="tab-overview" class="tab-content active"></div>
      <div id="tab-instit" class="tab-content"></div>
      <div id="tab-topics" class="tab-content"></div>
      <div id="tab-channels" class="tab-content"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const fileInput = document.getElementById('file-input');
    const uploadLabel = document.getElementById('upload-label');
    const execBtn = document.getElementById('exec-btn');
    const mainContent = document.getElementById('main-content');
    let workbookData = null;
    let latestExecutiveData = null;

    function showToast(msg, type) {
        const c = document.getElementById('toast-container');
        const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `${icon} ${msg}`;
        c.appendChild(t); setTimeout(() => t.remove(), 4000);
    }

    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const map = {'tab-overview':0, 'tab-instit':1, 'tab-topics':2, 'tab-channels':3};
        document.querySelectorAll('.tab-btn')[map[tabId]].classList.add('active');
    }

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      uploadLabel.innerHTML = `⏳ Elaborazione di <strong>${file.name}</strong>...`;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
            workbookData = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const data = XLSX.utils.sheet_to_json(workbookData.Sheets[workbookData.SheetNames[0]], { raw: false });
            renderReport(data);
            mainContent.style.display = 'block';
            execBtn.style.display = 'inline-block';
            uploadLabel.innerHTML = `✅ <strong>${file.name}</strong> caricato con successo.`;
            showToast('Dati elaborati correttamente', 'success');
        } catch (err) {
            console.error(err);
            uploadLabel.innerHTML = `❌ Errore nel file.`;
            showToast('Errore lettura file Excel', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    });

    execBtn.addEventListener('click', () => {
        if (!latestExecutiveData) return;
        const now = new Date();
        const filename = `ES2_${now.toISOString().slice(0,19).replace(/[-:T]/g,'_')}.json`;
        const blob = new Blob([JSON.stringify(latestExecutiveData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });

    // Helpers
    function formatDate(t) { if(!t) return ''; let d,m,y; if(/^\d{4}-\d{2}-\d{2}$/.test(t))[y,m,d]=t.split('-'); else if(/^\d{2}\/\d{2}\/\d{4}$/.test(t))[d,m,y]=t.split('/'); else{const dt=new Date(t);if(!isNaN(dt)){d=dt.getDate();m=dt.getMonth()+1;y=dt.getFullYear();}else return t;} return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y.toString().slice(-2)}`; }
    function formatNumber(n) { n=Number(n)||0; if(n<1000)return n.toString(); if(n<1000000)return `${Math.round(n/1000)}K`; return `${(n/1000000).toFixed(2).replace('.',',')}M`; }
    function formatNumberForJson(n) { let v=Number(n)||0; if(v>=1000000)return (v/1000000).toFixed(2).replace('.',',')+"M"; if(v>=1000)return Math.round(v/1000)+"K"; return v.toString().replace('.',','); }

    // --- FUNZIONE COPIA ROBUSTA ---
    function performCopy(text, btnElement) {
        if (!text) { showToast('Nessun testo da copiare', 'error'); return; }
        const onSuccess = () => {
            btnElement.innerHTML = '<i class="fas fa-check"></i>';
            btnElement.style.color = '#27ae60';
            setTimeout(() => { 
                btnElement.innerHTML = '<i class="far fa-copy"></i>'; 
                btnElement.style.color = '';
            }, 1500);
        };
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(onSuccess).catch(() => fallbackCopy(text, onSuccess));
        } else {
            fallbackCopy(text, onSuccess);
        }
    }

    function fallbackCopy(text, onSuccess) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        try { document.execCommand('copy'); onSuccess(); } 
        catch (err) { showToast('Impossibile copiare il testo', 'error'); }
        document.body.removeChild(textArea);
    }

    function createCopyBtn(textToCopy, tooltip = "Copia") {
        const b = document.createElement('button'); 
        b.className = 'copy-btn'; 
        b.innerHTML = '<i class="far fa-copy"></i>'; 
        b.title = tooltip;
        const safeText = String(textToCopy !== undefined && textToCopy !== null ? textToCopy : "");
        b.onclick = (e) => { e.stopPropagation(); performCopy(safeText, b); };
        return b;
    }

    function getChannelIcon(name) {
        const n = name.toLowerCase();
        if(n.includes('facebook')) return '<i class="fab fa-facebook"></i>';
        if(n.includes('instagram')) return '<i class="fab fa-instagram"></i>';
        if(n.includes('linkedin')) return '<i class="fab fa-linkedin"></i>';
        if(n.includes('twitter') || n.includes('x')) return '<i class="fa-brands fa-x-twitter"></i>'; 
        if(n.includes('youtube')) return '<i class="fab fa-youtube"></i>';
        if(n.includes('whatsapp')) return '<i class="fab fa-whatsapp"></i>';
        return '<i class="fas fa-share-alt"></i>';
    }

    // MAIN RENDER
    function renderReport(data) {
      const filtered = data.filter(r=>String(r.Campagna).trim().toLowerCase()==='editoriale');
      const tabs = { ov: document.getElementById('tab-overview'), inst: document.getElementById('tab-instit'), top: document.getElementById('tab-topics'), chan: document.getElementById('tab-channels') };
      Object.values(tabs).forEach(t => t.innerHTML = '');

      // 1. OVERVIEW
      const counts = { fb:0, ig:0, wa:0, tw:0, li:0, yt:0 };
      filtered.forEach(r => {
          const c = r.Canale.trim().toLowerCase();
          if(c.includes('facebook')) counts.fb++; else if(c.includes('instagram')) counts.ig++; else if(c==='whatsapp') counts.wa++; else if(c.includes('twitter') || c.includes('x')) counts.tw++; else if(c.includes('linkedin')) counts.li++; else if(c.includes('youtube')) counts.yt++;
      });
      const totals = { 
          'Post Totali': {val: filtered.length, icon: '<i class="fas fa-layer-group"></i>'}, 
          'Facebook': {val: counts.fb, icon: getChannelIcon('facebook')}, 
          'Instagram': {val: counts.ig, icon: getChannelIcon('instagram')}, 
          'LinkedIn': {val: counts.li, icon: getChannelIcon('linkedin')}, 
          'X (Twitter)': {val: counts.tw, icon: getChannelIcon('x')}, 
          'YouTube': {val: counts.yt, icon: getChannelIcon('youtube')}, 
          'WhatsApp': {val: counts.wa, icon: getChannelIcon('whatsapp')} 
      };

      const ovCard = document.createElement('div'); ovCard.className = 'card';
      ovCard.innerHTML = '<h2><i class="fas fa-chart-pie"></i> Volumi di Pubblicazione</h2>';
      const grid = document.createElement('div'); grid.className = 'stats-grid';
      Object.entries(totals).forEach(([k, obj]) => {
          const card = document.createElement('div'); card.className = 'stat-card';
          const valDiv = document.createElement('div'); valDiv.className = 'stat-value';
          valDiv.textContent = obj.val; valDiv.appendChild(createCopyBtn(obj.val));
          card.innerHTML = `<span class="stat-label">${obj.icon} ${k}</span>`;
          card.appendChild(valDiv); grid.appendChild(card);
      });
      ovCard.appendChild(grid); tabs.ov.appendChild(ovCard);

      // 2. ISTITUZIONALI
      const istit = filtered.filter(r=>String(r.Istituzionale).trim()==='1');
      const kpiIst = {
          'N. Post': istit.length,
          'Visualizzazioni': istit.reduce((s,r)=>s+(Number(r.Visualizzazioni)||0),0),
          'Interazioni': istit.reduce((s,r)=>s+(Number(r.Interazioni)||0),0),
          'Like/Reazioni': istit.reduce((s,r)=>s+(Number(r['Like e reazioni'])||0),0),
          'Condivisioni': istit.reduce((s,r)=>s+(Number(r.Condivisioni)||0),0)
      };

      const istCard = document.createElement('div'); istCard.className='card';
      istCard.innerHTML = '<h2><i class="fas fa-university"></i> KPI Istituzionali</h2>';
      const istGrid = document.createElement('div'); istGrid.className = 'stats-grid';
      Object.entries(kpiIst).forEach(([k,v]) => {
          const card = document.createElement('div'); card.className = 'stat-card';
          const valDiv = document.createElement('div'); valDiv.className = 'stat-value';
          const fmt = formatNumber(v); valDiv.textContent = fmt; valDiv.appendChild(createCopyBtn(fmt));
          card.innerHTML = `<span class="stat-label">${k}</span>`;
          card.appendChild(valDiv); istGrid.appendChild(card);
      });
      istCard.appendChild(istGrid);

      // Best Perf Table (Table view for precision)
      const agg={};istit.forEach(r=>{const a=r.Argomento||'ND';if(!agg[a])agg[a]={v:0,i:0,l:0,c:0,lnk:r.Link};agg[a].v+=Number(r.Visualizzazioni)||0;agg[a].i+=Number(r.Interazioni)||0;agg[a].l+=Number(r['Like e reazioni'])||0;agg[a].c+=Number(r.Condivisioni)||0;});
      const top5=Object.entries(agg).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,5);

      const perfDiv = document.createElement('div'); perfDiv.style.marginTop='2rem';
      perfDiv.innerHTML = '<h3><i class="fas fa-trophy"></i> Best Performers (Top 5 per visualizzazioni)</h3>';
      const tblWrap = document.createElement('div'); tblWrap.className='table-wrapper';
      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th>Argomento</th><th>Visualizzazioni</th><th>Interazioni</th><th>Like</th><th>Link</th></tr></thead><tbody></tbody>';
      top5.forEach(o => {
          const tr = document.createElement('tr');
          [[o.arg],[formatNumber(o.v)],[formatNumber(o.i)],[formatNumber(o.l)]].forEach(([val]) => {
              const td = document.createElement('td'); td.textContent = val; td.appendChild(createCopyBtn(val)); tr.appendChild(td);
          });
          const tdLink = document.createElement('td');
          tdLink.innerHTML = `<a href="${o.lnk}" target="_blank" class="link-btn"><i class="fas fa-external-link-alt"></i> Apri</a>`;
          tr.appendChild(tdLink);
          tbl.querySelector('tbody').appendChild(tr);
      });
      tblWrap.appendChild(tbl); perfDiv.appendChild(tblWrap);
      istCard.appendChild(perfDiv); tabs.inst.appendChild(istCard);

      // 3. ARGOMENTI
      const topics={}; filtered.forEach(r=>{const a=r.Argomento||'Altro'; const v=Number(r.Visualizzazioni)||0; if(!topics[a])topics[a]={n:0,v:0}; topics[a].n++; topics[a].v+=v;});
      const topTopics = Object.entries(topics).map(([a,d])=>({arg:a,...d})).sort((a,b)=>b.v-a.v).slice(0,10);

      const topicCard = document.createElement('div'); topicCard.className='card';
      topicCard.innerHTML = '<h2><i class="fas fa-list-ol"></i> Top 10 Argomenti</h2>';
      const tblTWrap = document.createElement('div'); tblTWrap.className='table-wrapper';
      const tblT = document.createElement('table');
      tblT.innerHTML = '<thead><tr><th>Argomento</th><th>N. Post</th><th>Visualizzazioni Totali</th></tr></thead><tbody></tbody>';
      topTopics.forEach(t => {
          const tr = document.createElement('tr');
          const fmtV = formatNumber(t.v);
          [[t.arg], [t.n], [fmtV]].forEach(([val]) => {
             const td = document.createElement('td'); td.textContent = val; td.appendChild(createCopyBtn(val)); tr.appendChild(td);
          });
          tblT.querySelector('tbody').appendChild(tr);
      });
      tblTWrap.appendChild(tblT); topicCard.appendChild(tblTWrap); tabs.top.appendChild(topicCard);

      // EXECUTIVE DATA GENERATION
      const safeTop = [...topTopics]; while(safeTop.length<3) safeTop.push({arg:"",v:0});
      latestExecutiveData = {
          "Numero post Facebook": formatNumberForJson(counts.fb),
          "Numero post X (Twitter)": formatNumberForJson(counts.tw),
          "Numero post Linkedin": formatNumberForJson(counts.li),
          "Numero post Instagram": formatNumberForJson(counts.ig),
          "Numero post Youtube": formatNumberForJson(counts.yt),
          "Numero post Whatsapp": formatNumberForJson(counts.wa),
          "Argomenti più visualizzati 1": safeTop[0].arg, "Visualizzazione Argomenti più visualizzati 1": formatNumberForJson(safeTop[0].v),
          "Argomenti più visualizzati 2": safeTop[1].arg, "Visualizzazione Argomenti più visualizzati 2": formatNumberForJson(safeTop[1].v),
          "Argomenti più visualizzati 3": safeTop[2].arg, "Visualizzazione Argomenti più visualizzati 3": formatNumberForJson(safeTop[2].v),
          "Numero post istituzionali": formatNumberForJson(kpiIst['N. Post']),
          "Visualizzazione post istituzionali": formatNumberForJson(kpiIst['Visualizzazioni']),
          "Like + interazoni post istituzionali": formatNumberForJson(kpiIst['Interazioni'] + kpiIst['Like/Reazioni'])
      };

      // 4. CANALI (SOCIAL CARD VIEW - SORTED DROPDOWN)
      const chanCard = document.createElement('div'); chanCard.className='card';
      chanCard.innerHTML = `<h2><i class="fas fa-filter"></i> Feed di Canale</h2>`;
      
      const selDiv = document.createElement('div'); selDiv.className='channel-selector';
      selDiv.innerHTML = '<select id="chan-sel" style="padding:10px; font-size:1rem; border-radius:6px; border:1px solid #cbd5e0; width: 100%; max-width: 300px;"><option value="">-- Seleziona un Canale --</option></select>';
      
      // Calcolo Conteggio Post per Canale per ordinamento
      const chanCounts = {};
      filtered.forEach(r => {
        const c = r.Canale.trim().toLowerCase();
        if(!chanCounts[c]) chanCounts[c] = 0;
        chanCounts[c]++;
      });
      // Convertiamo in array e ordiniamo per conteggio decrescente
      const sortedChannels = Object.entries(chanCounts).sort((a,b) => b[1] - a[1]);

      sortedChannels.forEach(([cName, count]) => {
          const opt = document.createElement('option'); 
          opt.value = cName; 
          // Aggiungiamo il conteggio alla label per chiarezza
          opt.textContent = `${cName.toUpperCase()} (${count})`;
          selDiv.querySelector('select').appendChild(opt);
      });
      chanCard.appendChild(selDiv);
      
      const chanContent = document.createElement('div'); chanContent.style.marginTop='1.5rem';
      chanCard.appendChild(chanContent);
      
      selDiv.querySelector('select').addEventListener('change', (e) => {
          const c = e.target.value; chanContent.innerHTML=''; if(!c) return;
          const posts = filtered.filter(r=>r.Canale.trim().toLowerCase()===c);
          renderChannelCards(posts, chanContent, c);
      });
      tabs.chan.appendChild(chanCard);
    }

    // --- NUOVA VISTA A CARTE PER I CANALI ---
    function renderChannelCards(posts, container, channelName) {
        const createSec = (title, metric, iconClass) => {
            const wrap = document.createElement('div'); wrap.style.marginBottom='3rem';
            const sorted = [...posts].sort((a,b)=>(Number(b[metric])||0)-(Number(a[metric])||0));
            
            // Intestazione sezione e tasto download
            const headDiv = document.createElement('div'); 
            headDiv.style.display='flex'; headDiv.style.justifyContent='space-between'; headDiv.style.alignItems='center'; headDiv.style.marginBottom='1rem';
            headDiv.innerHTML = `<h3><i class="${iconClass}"></i> ${title}</h3>`;
            const btnEx = document.createElement('button'); btnEx.className='save-channel-table'; btnEx.style.marginBottom='0'; btnEx.innerHTML='<i class="fas fa-file-excel"></i> Excel';
            btnEx.onclick = () => {
                const ws = XLSX.utils.json_to_sheet(sorted.map(r=>({Label:r.Label, Arg:r.Argomento, Data:formatDate(r.Data), Copy:r.Copy, Vis:r.Visualizzazioni, Int:r.Interazioni, Link:r.Link})));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Dati');
                XLSX.writeFile(wb, `${channelName}_${metric}.xlsx`);
            };
            headDiv.appendChild(btnEx); wrap.appendChild(headDiv);

            // Contenitore Griglia
            const gridDiv = document.createElement('div'); 
            gridDiv.className = 'post-grid';
            
            let limit = 6; // Mostra 6 card per volta

            const renderCards = () => {
                gridDiv.innerHTML = '';
                sorted.slice(0, limit).forEach(r => {
                    const label = r.Label || 'Account';
                    const arg = r.Argomento || 'Generale';
                    const date = formatDate(r.Data);
                    const copyText = r.Copy || '';
                    const visF = formatNumber(r.Visualizzazioni);
                    const intF = formatNumber(r.Interazioni);
                    const link = r.Link || '#';

                    // Creazione DOM Card
                    const card = document.createElement('div');
                    card.className = 'post-card';

                    // 1. Header
                    const header = document.createElement('div'); header.className='post-header';
                    header.innerHTML = `<div class="post-channel-icon">${getChannelIcon(channelName)}</div>`;
                    
                    const meta = document.createElement('div'); meta.className='post-meta';
                    
                    const labelRow = document.createElement('div'); labelRow.className='post-label';
                    labelRow.textContent = label; 
                    labelRow.appendChild(createCopyBtn(label, 'Copia Label'));
                    
                    const dateRow = document.createElement('div'); dateRow.className='post-date';
                    dateRow.textContent = date;
                    dateRow.appendChild(createCopyBtn(date, 'Copia Data'));

                    meta.appendChild(labelRow); meta.appendChild(dateRow); header.appendChild(meta);

                    // 2. Body
                    const body = document.createElement('div'); body.className='post-body';
                    
                    const topicSpan = document.createElement('span'); topicSpan.className='post-topic';
                    topicSpan.textContent = arg;
                    topicSpan.appendChild(createCopyBtn(arg, 'Copia Argomento'));

                    const textDiv = document.createElement('div'); textDiv.className='post-text-wrapper';
                    const textP = document.createElement('div'); textP.className='post-text';
                    textP.textContent = copyText; // Usare textContent per sicurezza
                    
                    // Aggiungo tasto copia per il testo (absolute top right)
                    const copyBodyBtn = createCopyBtn(copyText, 'Copia Testo Post');
                    copyBodyBtn.style.float = 'right';
                    copyBodyBtn.style.marginLeft = '8px';
                    
                    // Assemblaggio Body
                    body.appendChild(topicSpan);
                    textP.prepend(copyBodyBtn); // Mette il bottone all'inizio del blocco testo
                    body.appendChild(textP);

                    // 3. Footer
                    const footer = document.createElement('div'); footer.className='post-footer';
                    
                    const metrics = document.createElement('div'); metrics.className='post-metrics';
                    
                    const mVis = document.createElement('div'); mVis.className='metric-item views';
                    mVis.innerHTML = '<i class="far fa-eye"></i> ' + visF;
                    mVis.appendChild(createCopyBtn(visF));
                    
                    const mInt = document.createElement('div'); mInt.className='metric-item likes';
                    mInt.innerHTML = '<i class="far fa-thumbs-up"></i> ' + intF;
                    mInt.appendChild(createCopyBtn(intF));

                    metrics.appendChild(mVis); metrics.appendChild(mInt);

                    const linkBtn = document.createElement('a'); linkBtn.className='post-link-btn';
                    linkBtn.href = link; linkBtn.target = '_blank';
                    linkBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    linkBtn.title = "Apri post originale";

                    footer.appendChild(metrics); footer.appendChild(linkBtn);

                    // Append Parts
                    card.appendChild(header);
                    card.appendChild(body);
                    card.appendChild(footer);

                    gridDiv.appendChild(card);
                });
            };
            
            renderCards();
            wrap.appendChild(gridDiv);

            // Bottoni "Mostra Altri"
            if(sorted.length > 6) {
                const ctrls = document.createElement('div'); 
                ctrls.style.marginTop='20px'; ctrls.style.display='flex'; ctrls.style.justifyContent='center'; ctrls.style.gap='15px';
                
                const btnMore = document.createElement('button'); btnMore.className='save-table'; btnMore.style.background='#fff'; btnMore.style.border='1px solid #ccc';
                btnMore.textContent = `Carica altri 6`;
                
                const btnAll = document.createElement('button'); btnAll.className='save-table'; btnAll.style.background='#fff'; btnAll.style.border='1px solid #ccc';
                btnAll.textContent = `Mostra tutti (${sorted.length})`;
                
                btnMore.onclick = () => { limit += 6; renderCards(); if(limit>=sorted.length) ctrls.style.display='none'; };
                btnAll.onclick = () => { limit = sorted.length; renderCards(); ctrls.style.display='none'; };
                
                ctrls.appendChild(btnMore); ctrls.appendChild(btnAll); wrap.appendChild(ctrls);
            }
            container.appendChild(wrap);
        };
        
        createSec('Top per Visualizzazioni', 'Visualizzazioni', 'fas fa-eye');
        createSec('Top per Interazioni', 'Interazioni', 'fas fa-thumbs-up');
    }
  </script>
</body>
</html>
